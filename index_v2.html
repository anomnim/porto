<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Log MP TAM</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
        }
        /* Style untuk radio button Ya/Tidak */
        .radio-group input:checked + label {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .radio-group label {
            transition: all 0.2s;
        }
        /* Style untuk Canvas Tanda Tangan */
        #signature-canvas {
            border: 1px solid #ccc;
            touch-action: none; /* Penting untuk interaksi sentuh */
        }
    </style>
    <!-- Blok script type="module" untuk otentikasi Firebase telah dihilangkan sepenuhnya -->
</head>
<body class="min-h-screen p-4 sm:p-8">
    
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-indigo-700 mb-6 border-b pb-4">Activity Log MP TAM (Mode Dev)</h1>
        
        <!-- Informasi Supervisor & App ID (Menggunakan nilai statis) -->
        <div class="text-sm text-gray-500 mb-6 bg-indigo-50 p-3 rounded-lg">
            <p>ID Supervisor: <span id="supervisor-id" class="font-mono text-indigo-600">DEV_MODE</span></p>
            <p>ID Aplikasi: <span id="app-id-display" class="font-mono text-indigo-600 text-xs">Loading...</span></p>
            <p class="mt-2 font-medium text-xs text-red-700">Catatan: Fitur Google Sheet dan Upload File disimulasikan dan hasilnya hanya tercetak di konsol (Console Log).</p>
        </div>

        <!-- Bagian Pemilihan Tim dan Karyawan -->
        <div id="employee-selection-section" class="space-y-6 mb-8 p-6 border border-gray-200 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-800">1. Pilih Karyawan</h2>
            
            <!-- Pemilihan Tim -->
            <div>
                <label for="team-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Tim</label>
                <select id="team-select" onchange="window.supervisorApp.selectTeam(this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="" disabled selected>-- Pilih Tim --</option>
                    <option value="Red">Red</option>
                    <option value="White">White</option>
                    <option value="Blue">Blue</option>
                </select>
            </div>
            
            <!-- Pemilihan Karyawan (Tergantung Tim) -->
            <div id="employee-lookup-container" class="hidden space-y-3">
                <label for="employee-search" class="block text-sm font-medium text-gray-700">Cari Nama Karyawan (Nama / NRK)</label>
                <input type="text" id="employee-search" oninput="window.supervisorApp.filterEmployees(this.value)" placeholder="Cari..." class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                
                <div id="employee-list-container" class="border border-gray-200 rounded-lg p-3 custom-scrollbar max-h-[160px] overflow-y-auto bg-gray-50">
                    <p class="text-sm text-gray-500" id="employee-list-message">Silakan pilih Tim terlebih dahulu.</p>
                    <ul id="employee-list" class="space-y-1">
                        <!-- Employee list will be rendered here -->
                    </ul>
                </div>
                
                <button id="show-more-btn" onclick="window.supervisorApp.toggleShowAllEmployees()" class="hidden text-indigo-600 hover:text-indigo-800 text-sm font-medium mt-1">
                    Lebih banyak...
                </button>
            </div>

             <!-- Karyawan yang Dipilih -->
            <div id="selected-employee-info" class="p-3 bg-indigo-100 border border-indigo-300 rounded-lg hidden">
                <p class="text-sm font-semibold text-indigo-700">Karyawan Dipilih:</p>
                <p class="text-lg font-bold text-indigo-900"><span id="selected-name"></span> (<span id="selected-nrk"></span>)</p>
                <button onclick="window.supervisorApp.resetEmployeeSelection()" class="text-xs text-red-500 hover:text-red-700 mt-1">Ubah Pilihan</button>
            </div>
        </div>

        <!-- Bagian Pemilihan Halaman Tujuan -->
        <div id="page-selection-section" class="space-y-4 p-6 bg-indigo-50 border border-indigo-200 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-800">2. Pilih Halaman Tujuan</h2>
            <p class="text-sm text-gray-600">Pilih salah satu fungsi di bawah ini untuk Karyawan yang telah dipilih.</p>
            <div class="flex flex-col space-y-4 md:flex-row md:space-y-0 md:space-x-4">
                <button onclick="window.supervisorApp.selectPage('kelayakan')" id="btn-kelayakan" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50" disabled>
                    <span class="text-2xl">üìù</span> Form Kelayakan Kerja
                </button>
                <button onclick="window.supervisorApp.selectPage('sakit')" id="btn-sakit" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50" disabled>
                    <span class="text-2xl">ü§í</span> Form Ijin Sakit & Upload Surat
                </button>
            </div>
        </div>

        <!-- Formulir Kelayakan Kerja (Page 1) -->
        <div id="page-kelayakan" class="mt-8 hidden p-6 border border-indigo-300 rounded-xl bg-white shadow-lg">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Form Kelayakan Kerja Karyawan</h2>
            <p class="text-sm text-gray-600 mb-6">Supervisor: Jawab pertanyaan di bawah ini dengan 'Ya' atau 'Tidak'.</p>
            <form id="form-kelayakan" onsubmit="window.supervisorApp.submitForm('kelayakan', event)" class="space-y-5">
                
                <div id="kelayakan-questions" class="space-y-5">
                    <!-- Pertanyaan akan dirender di sini oleh JavaScript -->
                </div>
                
                <!-- Field Keterangan Tambahan (Remarks) -->
                <div>
                    <label for="kelayakan-remarks" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Tambahan (Maks. 500 Karakter)</label>
                    <textarea id="kelayakan-remarks" maxlength="500" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Masukkan keterangan tambahan jika diperlukan..."></textarea>
                    <p class="text-xs text-gray-500 mt-1"><span id="remark-count">0</span>/500 karakter</p>
                </div>

                <!-- Field Tanda Tangan Karyawan -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-base font-semibold text-gray-800 mb-2">Tanda Tangan Karyawan</h3>
                    <div class="p-2 border border-gray-300 rounded-lg bg-white shadow-inner">
                        <canvas id="signature-canvas" class="w-full" height="150"></canvas>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button type="button" onclick="window.supervisorApp.clearSignature()" class="flex-1 bg-yellow-500 text-white text-sm py-2 rounded-md hover:bg-yellow-600 transition duration-300">
                            Hapus Tanda Tangan
                        </button>
                    </div>
                    <p class="text-xs text-red-500 mt-2" id="signature-error" style="display: none;">Harap masukkan tanda tangan sebelum mengirim.</p>
                </div>

                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-green-700 transition duration-300">
                    Kirim Data Kelayakan Kerja
                </button>
            </form>
        </div>

        <!-- Formulir Ijin Sakit (Page 2) -->
        <div id="page-sakit" class="mt-8 hidden p-6 border border-indigo-300 rounded-xl bg-white shadow-lg">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Form Ijin Sakit & Upload Surat</h2>
            <p class="text-sm text-gray-600 mb-6">Supervisor: Pilih tanggal sakit (dipisahkan koma untuk multiple) dan upload surat sakit karyawan.</p>
            <form id="form-sakit" onsubmit="window.supervisorApp.submitForm('sakit', event)" class="space-y-5">
                
                <div>
                    <label for="sick-dates" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Ijin Sakit (Contoh: 2025-10-01, 2025-10-02)</label>
                    <input type="text" id="sick-dates" placeholder="yyyy-mm-dd, yyyy-mm-dd..." required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <p class="text-xs text-gray-500 mt-1">Tanggal masa lalu yang bisa dipilih maksimal adalah H-1 (Kemarin).</p>
                </div>

                <div>
                    <label for="sick-note-file" class="block text-sm font-medium text-gray-700 mb-1">Upload Surat Sakit (Dokter/Klinik)</label>
                    <!-- Menambahkan 'capture=camera' untuk mendukung kamera HP -->
                    <input type="file" id="sick-note-file" accept=".pdf,image/*" capture="camera" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p class="text-xs text-gray-500 mt-1">Max 10MB. Nama file akan disimulasikan sebagai 'yyyy-mm-dd_nama karyawan_dd-mmm-yyyy'.</p>
                </div>
                
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-red-700 transition duration-300">
                    Kirim Data Ijin Sakit
                </button>
            </form>
        </div>

        <!-- Message Box for Confirmation/Error (Using Modal/Toast pattern) -->
        <div id="message-box" class="fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-xl hidden transition-all duration-300 ease-out z-50 max-w-sm">
            <p id="message-text" class="font-semibold"></p>
            <button onclick="document.getElementById('message-box').classList.add('hidden')" class="ml-4 text-sm font-medium hover:text-gray-100">Tutup</button>
        </div>

    </div>

    <script type="text/javascript">
        // Global State and Logic
        window.supervisorApp = (function() {
            // --- KONSTANTA APLIKASI ---
            const GSHEET_FILE_ID = '1VhLZVv8yZlqOOqj_TiH8ycetOQoEGYIJlyUCFFXA3vc';
            const DRIVE_FOLDER_ID = '1D71xhO6ta8R_q8HNOv7aQNx6txixdVuh';
            const MAX_FILE_SIZE_MB = 10;
            const supervisorId = 'DEV_MODE'; // Statis karena otentikasi dinonaktifkan

            // --- STATE GLOBAL ---
            let selectedTeam = '';
            let selectedEmployee = null; // { name: '...', nrk: '...' }
            let currentFilter = '';
            let showAllEmployees = false;
            
            // --- Mock Employee Data (Simulasi data dari Sheet 'MP') ---
            // Data ini digunakan sebagai pengganti API call GSheet untuk mode development
            const employeeDatabase = {
                'Red': [
                    { team: 'Red', nrk: 'R1001', name: 'Bambang Sudarsono' },
                    { team: 'Red', nrk: 'R1002', name: 'Siti Nurhaliza' },
                    { team: 'Red', nrk: 'R1003', name: 'Joko Widodo' },
                    { team: 'Red', nrk: 'R1004', name: 'Ayu Tingting' },
                    { team: 'Red', nrk: 'R1005', name: 'Denny Sumargo' },
                    { team: 'Red', nrk: 'R1006', name: 'Raisa Andriana' },
                    { team: 'Red', nrk: 'R1007', name: 'Tulus Pamungkas' },
                ],
                'White': [
                    { team: 'White', nrk: 'W2001', name: 'Michael Jordan' },
                    { team: 'White', nrk: 'W2002', name: 'LeBron James' },
                    { team: 'White', nrk: 'W2003', name: 'Kobe Bryant' },
                    { team: 'White', nrk: 'W2004', name: 'Stephen Curry' },
                ],
                'Blue': [
                    { team: 'Blue', nrk: 'B3001', name: 'Dewi Sandra' },
                    { team: 'Blue', nrk: 'B3002', name: 'Rio Dewanto' },
                ]
            };
            
            // --- Pertanyaan Kelayakan (Form Kelayakan) ---
            const kelayakanQuestions = [
                'Apakah tidur cukup (‚â•6 jam), dari jam berapa?',
                'Apakah merasa lelah berlebihan?',
                'Apakah mengalami sakit kepala / pusing?',
                'Apakah mengalami mual / gangguan pencernaan?',
                'Apakah ada keluhan nyeri otot / sendi?',
                'Apakah mengonsumsi obat-obatan yang bisa membuat ngantuk sebelum bekerja?',
                'Apakah mengonsumsi alkohol / zat terlarang dalam 24 jam terakhir?',
                'Apakah sedang dalam kondisi sakit (flu, batuk, demam, cedera)?',
                'Apakah ada gejala mengantuk berlebihan?',
                'Peralatan APD lengkap dan dipakai dengan benar',
                'Tidak ada gangguan penglihatan / pendengaran yang menghambat kerja',
                'Dalam kondisi fit untuk menjalankan tugas'
            ];


            // --- DOM Elements ---
            const $employeeLookupContainer = document.getElementById('employee-lookup-container');
            const $employeeList = document.getElementById('employee-list');
            const $employeeListMessage = document.getElementById('employee-list-message');
            const $employeeSearch = document.getElementById('employee-search');
            const $showMoreBtn = document.getElementById('show-more-btn');
            const $selectedEmployeeInfo = document.getElementById('selected-employee-info');
            const $selectedName = document.getElementById('selected-name');
            const $selectedNRK = document.getElementById('selected-nrk');
            const $btnKelayakan = document.getElementById('btn-kelayakan');
            const $btnSakit = document.getElementById('btn-sakit');
            const $pageKelayakan = document.getElementById('page-kelayakan');
            const $pageSakit = document.getElementById('page-sakit');
            const $kelayakanQuestionsDiv = document.getElementById('kelayakan-questions');
            const $messageBox = document.getElementById('message-box');
            const $messageText = document.getElementById('message-text');
            const $remarksInput = document.getElementById('kelayakan-remarks');
            const $remarkCount = document.getElementById('remark-count');
            const $signatureError = document.getElementById('signature-error');

            // Signature Canvas variables
            let canvas, ctx, isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // --- Helper Functions ---

            function showMessage(text, isError = false) {
                $messageText.innerText = text;
                $messageBox.classList.remove('hidden');
                $messageBox.classList.remove('bg-green-500', 'bg-red-500');
                $messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
                setTimeout(() => {
                    $messageBox.classList.add('hidden');
                }, 5000);
            }

            function updateButtonsState() {
                const isDisabled = !selectedEmployee;
                $btnKelayakan.disabled = isDisabled;
                $btnSakit.disabled = isDisabled;
            }

            function hideAllPages() {
                $pageKelayakan.classList.add('hidden');
                $pageSakit.classList.add('hidden');
            }

            function resetEmployeeSelection() {
                selectedEmployee = null;
                selectedTeam = '';
                document.getElementById('team-select').value = '';
                $employeeSearch.value = '';
                $employeeLookupContainer.classList.add('hidden');
                $selectedEmployeeInfo.classList.add('hidden');
                hideAllPages();
                updateButtonsState();
                renderEmployeeList(); // Clear list
                showMessage('Pilihan karyawan direset.', true);
            }
            
            // --- Employee List Logic ---

            function renderEmployeeList() {
                // ... (Logic to filter and render employee list remains the same)
                if (!selectedTeam) {
                    $employeeListMessage.classList.remove('hidden');
                    $employeeListMessage.innerText = 'Silakan pilih Tim terlebih dahulu.';
                    $employeeList.innerHTML = '';
                    $showMoreBtn.classList.add('hidden');
                    return;
                }

                $employeeListMessage.classList.add('hidden');
                const teamData = employeeDatabase[selectedTeam] || [];
                const searchLower = currentFilter.toLowerCase();
                
                // 1. Filter based on search input
                const filteredEmployees = teamData.filter(emp => 
                    emp.name.toLowerCase().includes(searchLower) || 
                    emp.nrk.toLowerCase().includes(searchLower)
                );

                const listToShow = (showAllEmployees || filteredEmployees.length <= 4) 
                    ? filteredEmployees 
                    : filteredEmployees.slice(0, 4);
                
                // 2. Render the list
                $employeeList.innerHTML = '';
                if (filteredEmployees.length === 0) {
                    $employeeListMessage.classList.remove('hidden');
                    $employeeListMessage.innerText = 'Tidak ada karyawan yang ditemukan.';
                }

                listToShow.forEach(emp => {
                    const li = document.createElement('li');
                    li.className = 'p-2 rounded-md hover:bg-indigo-100 cursor-pointer text-sm text-gray-800 transition duration-150';
                    li.innerHTML = `<span class="font-medium">${emp.name}</span> <span class="text-gray-500">(${emp.nrk})</span>`;
                    li.onclick = () => selectEmployee(emp);
                    $employeeList.appendChild(li);
                });

                // 3. Handle 'More...' button
                if (filteredEmployees.length > 4) {
                    $showMoreBtn.classList.remove('hidden');
                    $showMoreBtn.innerText = showAllEmployees ? 'Sembunyikan' : `Lebih banyak... (${filteredEmployees.length - 4} lainnya)`;
                } else {
                    $showMoreBtn.classList.add('hidden');
                }
            }

            function selectTeam(team) {
                // ... (Logic remains the same)
                selectedTeam = team;
                selectedEmployee = null;
                currentFilter = '';
                $employeeSearch.value = '';
                $selectedEmployeeInfo.classList.add('hidden');
                hideAllPages();
                updateButtonsState();
                
                if (team) {
                    $employeeLookupContainer.classList.remove('hidden');
                    renderEmployeeList();
                    showMessage(`Tim ${team} dipilih. Silakan pilih Karyawan.`);
                } else {
                    $employeeLookupContainer.classList.add('hidden');
                }
            }

            function filterEmployees(query) {
                currentFilter = query;
                showAllEmployees = false;
                renderEmployeeList();
            }

            function toggleShowAllEmployees() {
                showAllEmployees = !showAllEmployees;
                renderEmployeeList();
            }

            function selectEmployee(emp) {
                // ... (Logic remains the same)
                selectedEmployee = emp;
                $selectedName.innerText = emp.name;
                $selectedNRK.innerText = emp.nrk;
                $selectedEmployeeInfo.classList.remove('hidden');
                $employeeLookupContainer.classList.add('hidden'); // Hide lookup after selection
                updateButtonsState();
                showMessage(`Karyawan ${emp.name} (${emp.nrk}) dipilih. Sekarang, pilih Halaman Tujuan.`);
            }

            function selectPage(page) {
                // ... (Logic remains the same, with added signature canvas init)
                if (!selectedEmployee) {
                    showMessage('Harap pilih karyawan terlebih dahulu.', true);
                    return;
                }
                
                hideAllPages();
                if (page === 'kelayakan') {
                    $pageKelayakan.classList.remove('hidden');
                    initializeKelayakanForm(); // Setup questions and canvas
                    showMessage('Mengisi Form Kelayakan Kerja.', false);
                } else if (page === 'sakit') {
                    $pageSakit.classList.remove('hidden');
                    showMessage('Mengisi Form Ijin Sakit.', false);
                }
            }

            // --- Signature Canvas Logic (Form Kelayakan) ---
            function setupSignatureCanvas() {
                canvas = document.getElementById('signature-canvas');
                ctx = canvas.getContext('2d');
                
                // Set canvas size responsively
                const containerWidth = canvas.parentElement.clientWidth;
                canvas.width = containerWidth;
                
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                
                const getCoords = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    if (e.touches) {
                        return { 
                            x: e.touches[0].clientX - rect.left, 
                            y: e.touches[0].clientY - rect.top 
                        };
                    }
                    return { 
                        x: e.clientX - rect.left, 
                        y: e.clientY - rect.top 
                    };
                };

                const startDrawing = (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    const { x, y } = getCoords(e);
                    [lastX, lastY] = [x, y];
                };

                const draw = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault();
                    const { x, y } = getCoords(e);
                    
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                };

                const stopDrawing = () => {
                    isDrawing = false;
                };

                // Mouse events
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                // Touch events
                canvas.addEventListener('touchstart', startDrawing);
                canvas.addEventListener('touchmove', draw);
                canvas.addEventListener('touchend', stopDrawing);

                // Fill background white
                clearCanvas();
            }
            
            function clearCanvas() {
                if (ctx) {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    $signatureError.style.display = 'none';
                }
            }

            function getSignatureDataURL() {
                // Check if the canvas is empty (only white background)
                const dataUrl = canvas.toDataURL('image/png');
                const blankCanvas = document.createElement('canvas');
                blankCanvas.width = canvas.width;
                blankCanvas.height = canvas.height;
                const blankCtx = blankCanvas.getContext('2d');
                blankCtx.fillStyle = 'white';
                blankCtx.fillRect(0, 0, blankCanvas.width, blankCanvas.height);
                
                if (dataUrl === blankCanvas.toDataURL('image/png')) {
                    return null; // Canvas kosong
                }
                
                return dataUrl;
            }
            
            // --- Kelayakan Form Setup ---
            function initializeKelayakanForm() {
                // 1. Render Questions
                $kelayakanQuestionsDiv.innerHTML = kelayakanQuestions.map((q, index) => `
                    <div class="border p-4 rounded-lg bg-white shadow-sm">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">${index + 1}. ${q}</label>
                        <div class="radio-group flex space-x-4 mt-2">
                            <input type="radio" id="q${index}-ya" name="question_${index}" value="Ya" class="hidden" required>
                            <label for="q${index}-ya" class="flex-1 text-center py-2 px-4 rounded-lg cursor-pointer border border-indigo-400 text-indigo-700 hover:bg-indigo-100 font-medium">
                                Ya
                            </label>
                            
                            <input type="radio" id="q${index}-tidak" name="question_${index}" value="Tidak" class="hidden" required>
                            <label for="q${index}-tidak" class="flex-1 text-center py-2 px-4 rounded-lg cursor-pointer border border-indigo-400 text-indigo-700 hover:bg-indigo-100 font-medium">
                                Tidak
                            </label>
                        </div>
                    </div>
                `).join('');

                // 2. Setup Remarks character counter
                $remarksInput.addEventListener('input', () => {
                    $remarkCount.innerText = $remarksInput.value.length;
                });
                
                // 3. Setup Signature Canvas
                setupSignatureCanvas();
            }

            // --- Submission Logic (Simulated) ---

            function formatDate(date, format) {
                const map = {
                    mm: date.getMonth() + 1,
                    dd: date.getDate(),
                    yy: date.getFullYear().toString().slice(-2),
                    yyyy: date.getFullYear(),
                    HH: ('0' + date.getHours()).slice(-2),
                    MM: ('0' + date.getMinutes()).slice(-2)
                };
                
                // For 'mmm' format (Indonesian Month short form)
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
                
                let dateString = format;
                dateString = dateString.replace('dd', ('0' + map.dd).slice(-2));
                dateString = dateString.replace('mmm', monthNames[date.getMonth()]);
                dateString = dateString.replace('yyyy', map.yyyy);
                dateString = dateString.replace('hh', map.HH); // Use HH for 24h format
                dateString = dateString.replace('mm', map.MM);
                
                return dateString;
            }

            async function saveToGoogleSheet(sheetName, data) {
                // Fungsi ini akan menjadi tempat integrasi API Google Sheet (misalnya, Google Apps Script Web App URL)
                console.log(`\n======================================================`);
                console.log(`[SIMULASI GSheet] Menyimpan ke File ID: ${GSHEET_FILE_ID} | Sheet: ${sheetName}`);
                console.log(`Data yang akan disimpan (Format Baris GSheet):`);
                console.table(data);
                console.log(`======================================================\n`);
                
                await new Promise(resolve => setTimeout(resolve, 1500)); 

                showMessage(`Data berhasil disimulasikan dan dicatat ke konsol untuk Sheet '${sheetName}'!`);
            }
            
            async function submitForm(type, event) {
                event.preventDefault();
                
                if (!selectedEmployee) {
                    showMessage('Error: Pemilihan karyawan belum selesai.', true);
                    return;
                }

                const submissionTime = new Date();
                
                const commonData = {
                    timestamp: submissionTime,
                    supervisorId: supervisorId, 
                    team: selectedTeam,
                    employeeName: selectedEmployee.name,
                    employeeNRK: selectedEmployee.nrk,
                };

                let sheetName = '';
                let gsheetRowData = []; // Array of values to match GSheet columns

                // --- FORM KELAYAKAN LOGIC ---
                if (type === 'kelayakan') {
                    sheetName = 'Form Kelayakan';
                    
                    const signatureDataUrl = getSignatureDataURL();
                    if (!signatureDataUrl) {
                        $signatureError.style.display = 'block';
                        showMessage('Harap masukkan tanda tangan karyawan.', true);
                        return;
                    }
                    $signatureError.style.display = 'none';

                    // 1. Timestamp (A)
                    gsheetRowData.push(formatDate(submissionTime, 'dd-mmm-yyyy hh:mm')); 
                    // 2. Nama (B)
                    gsheetRowData.push(commonData.employeeName);
                    // 3. Tim (C)
                    gsheetRowData.push(commonData.team);

                    // 4. Pertanyaan D-O (12 Pertanyaan)
                    const formKelayakan = document.getElementById('form-kelayakan');
                    kelayakanQuestions.forEach((q, index) => {
                        const answer = formKelayakan.querySelector(`input[name="question_${index}"]:checked`)?.value || 'N/A';
                        gsheetRowData.push(answer);
                    });

                    // 5. Remarks (P)
                    const remarks = $remarksInput.value.trim();
                    gsheetRowData.push(remarks);

                    // 6. Tanda Tangan (Q) - SIMULASI HYPERLINK
                    // Dalam implementasi nyata, Base64 ini akan diupload ke Drive (Folder ID) 
                    // dan URL yang dihasilkan akan dimasukkan ke GSheet.
                    const signatureUrlPlaceholder = `https://drive.google.com/uc?id=[FILE_ID_UPLOADED]`; 
                    const gsheetHyperlinkFormula = `=HYPERLINK("${signatureUrlPlaceholder}", "Lihat Tanda Tangan ${commonData.employeeNRK}")`;
                    gsheetRowData.push(gsheetHyperlinkFormula);

                    // PENTING: Batasi data sampai kolom Q
                    gsheetRowData = gsheetRowData.slice(0, 17); // A=0, Q=16 -> length 17

                } 
                
                // --- FORM IJIN SAKIT LOGIC ---
                else if (type === 'sakit') {
                    sheetName = 'Ijin Sakit';
                    const sickDatesInput = document.getElementById('sick-dates').value.trim();
                    const fileInput = document.getElementById('sick-note-file');
                    
                    if (!sickDatesInput) {
                        showMessage('Harap masukkan setidaknya satu Tanggal Ijin Sakit.', true);
                        return;
                    }

                    // VALIDASI TANGGAL
                    const dates = sickDatesInput.split(',').map(d => d.trim()).filter(d => d.match(/^\d{4}-\d{2}-\d{2}$/));
                    if (dates.length === 0) {
                        showMessage('Format tanggal tidak valid. Gunakan format yyyy-mm-dd dan pisahkan dengan koma.', true);
                        return;
                    }
                    
                    // Batasi tanggal masa lalu maksimal H-1
                    const yesterday = new Date(submissionTime);
                    yesterday.setDate(yesterday.getDate() - 1);
                    yesterday.setHours(0, 0, 0, 0);

                    for (const dateStr of dates) {
                        const dateObj = new Date(dateStr);
                        dateObj.setHours(0, 0, 0, 0);

                        if (dateObj < yesterday) {
                             showMessage(`Tanggal ${dateStr} terlalu jauh ke masa lalu. Maksimal H-1 (Kemarin) adalah ${formatDate(yesterday, 'yyyy-mm-dd')}.`, true);
                            return;
                        }
                    }
                    
                    const firstSickDate = dates.sort()[0]; // Ambil tanggal pertama yang paling awal
                    const firstSickDateFormatted = formatDate(new Date(firstSickDate), 'dd-mmm-yyyy');
                    
                    // VALIDASI FILE
                    let fileNameForGSheet = 'Tidak Ada File Diupload';
                    let fileSimulatedName = '';

                    if (fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                            showMessage(`Ukuran file melebihi batas ${MAX_FILE_SIZE_MB}MB.`, true);
                            return;
                        }
                        
                        // Format penamaan file simulasi
                        fileSimulatedName = `${formatDate(submissionTime, 'yyyy-mm-dd')}_${commonData.employeeName.replace(/\s/g, '_')}_${firstSickDateFormatted}.png`;
                        
                        // SIMULASI HYPERLINK
                        const fileUrlPlaceholder = `https://drive.google.com/uc?id=[FILE_ID_UPLOADED]`; 
                        fileNameForGSheet = `=HYPERLINK("${fileUrlPlaceholder}", "Lihat Surat Sakit (${file.name})")`;
                    }

                    // Data untuk GSheet 'Ijin Sakit' (Kolom yang Anda butuhkan)
                    gsheetRowData.push(formatDate(submissionTime, 'dd-mmm-yyyy hh:mm')); 
                    gsheetRowData.push(commonData.employeeName);
                    gsheetRowData.push(commonData.team);
                    gsheetRowData.push(sickDatesInput); // Semua tanggal sakit
                    gsheetRowData.push(fileNameForGSheet);
                    gsheetRowData.push(`[Simulasi Upload ke Folder: ${DRIVE_FOLDER_ID}, Nama File: ${fileSimulatedName}]`);
                }

                await saveToGoogleSheet(sheetName, gsheetRowData);
                
                // Setelah berhasil, reset formulir dan kembali ke pemilihan halaman
                document.getElementById(`form-${type}`).reset();
                hideAllPages();
                resetEmployeeSelection();
                clearCanvas(); // Pastikan canvas tanda tangan juga direset
            }

            // Initial rendering
            document.addEventListener('DOMContentLoaded', () => {
                // Set App ID statis
                const appId = 'supervisor-app-dev';
                document.getElementById('app-id-display').innerText = appId;
                
                renderEmployeeList();
                updateButtonsState();
            });


            // Expose public methods
            return {
                selectTeam,
                filterEmployees,
                toggleShowAllEmployees,
                selectEmployee,
                resetEmployeeSelection,
                selectPage,
                submitForm,
                clearSignature: clearCanvas
            };
        })();
    </script>
</body>
</html>
