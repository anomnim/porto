// 20251007 ganti ttd jadi selfie

/**
 * Melayani (Serve) antarmuka web HTML.
 */
function doGet() {
  // Menggunakan HtmlService untuk memuat template index.html
  return HtmlService.createTemplateFromFile('index')
      .evaluate()
      .setTitle('Activity Log MP');
}

/**
 * Mengambil data karyawan dari Google Sheet berdasarkan nama tim yang dipilih.
 * ID file sheet dan nama sheet sudah ditetapkan sesuai permintaan.
 * @param {string} teamName Nama tim: 'Red' atau 'White'.
 * @return {Object} Objek respons yang berisi status sukses dan data karyawan.
 */
function getEmployees(teamName) {
  // ID Google Sheet yang disediakan oleh pengguna
  const SPREADSHEET_ID = '1VhLZVv8yZlqOOqj_TiH8ycetOQoEGYIJlyUCFFXA3vc';
  const SHEET_NAME = 'database';
  
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(SHEET_NAME);

    if (!sheet) {
      // Baris ini akan menyebabkan error yang ditangkap di catch jika sheet benar-benar tidak ada.
      // Jika ingin membuat sheet otomatis, tambahkan: ss.insertSheet(SHEET_NAME);
      return { success: false, data: [], error: 'Sheet "database" tidak ditemukan. Pastikan nama sheet sudah benar.' };
    }

    // Baris header berada di baris ke-3. Data dimulai dari baris ke-4 (indeks 3).
    // Berdasarkan asumsi dari kode sebelumnya, kita akan gunakan indeks 1 (Baris 2)
    const HEADER_ROW = 1; 
    const dataRange = sheet.getDataRange();
    const allData = dataRange.getValues();
    
    // ASUMSI INDEKS KOLOM: A: Team (0), B: NRK Karyawan (1), C: Nama Karyawan (2), F: Penempatan Karyawan (5)
    const COL_TEAM = 0; 
    const COL_NRK = 1; 
    const COL_NAMA = 2; 
    const COL_PENEMPATAN = 5; 

    if (allData.length <= HEADER_ROW) {
       return { success: false, data: [], error: 'Tidak ada data karyawan ditemukan setelah baris header.' };
    }

    // Filter data dimulai dari baris setelah header
    const employeeData = allData.slice(HEADER_ROW).reduce((acc, row) => {
      const team = (row[COL_TEAM] || '').toString().trim();
      const nama = (row[COL_NAMA] || '').toString().trim();
      const nrk = (row[COL_NRK] || '').toString().trim();
      const penempatan = (row[COL_PENEMPATAN] || '').toString().trim();

      // Memastikan data tim, nama, dan nrk ada, dan tim sesuai dengan yang dipilih
      if (team.toUpperCase() === teamName.toUpperCase() && nama && nrk) {
        acc.push({
          nrk: nrk,
          nama: nama,
          penempatan: penempatan,
          // Format yang diminta: 'Nama (NRK)'
          display: `${nama} (${nrk})` 
        });
      }
      return acc;
    }, []);

    return { success: true, data: employeeData };

  } catch (e) {
    Logger.log('Error in getEmployees: ' + e.toString());
    return { success: false, data: [], error: 'Terjadi kesalahan saat mengambil data. Periksa ID Sheet dan izin akses. Detail: ' + e.toString() };
  }
}

/**
 * Menyimpan data Form Kelayakan Kerja dan tanda tangan ke Google Sheet dan Drive.
 * @param {Object} formData Objek yang berisi data formulir (nama, tim, 12 pertanyaan, remarks).
 * @param {string} signatureDataUrl Data URI (base64) dari tanda tangan.
 * @return {Object} Objek respons yang berisi status sukses atau error.
 */
function saveFitnessForm(formData, selfieDataUrl) {
  const SPREADSHEET_ID = '1VhLZVv8yZlqOOqj_TiH8ycetOQoEGYIJlyUCFFXA3vc';
  const SHEET_NAME = 'Form Kelayakan';
  const FOLDER_ID = '1D71xhO6ta8R_q8HNOv7aQNx6txixdVuh';

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME);
    
    // 1. Inisialisasi Sheet dan Headers jika belum ada
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME);
      const headers = [
        'Timestamp', 'Nama', 'NRK', 'Tim', 
        'Apakah tidur cukup (>=6 jam)?',
        'Apakah merasa lelah berlebihan?',
        'Apakah ada gejala mengantuk berlebihan?',
        'Apakah sebelumnya lembur lebih dari 12 jam?',
        'Apakah mengalami sakit kepala / pusing?',
        'Apakah mengalami mual / gangguan pencernaan?',
        'Apakah ada keluhan nyeri otot / sendi?',
        'Apakah sedang dalam kondisi sakit (flu, batuk, demam, cedera)?',
        'Apakah mengonsumsi obat-obatan sebelum bekerja?',
        'Apakah mengonsumsi alkohol / zat terlarang dalam 24 jam terakhir?',
        'Apakah ada gangguan penglihatan / pendengaran yang menghambat kerja',
        'Apakah Peralatan APD lengkap dan dipakai dengan benar',
        'Apakah dalam kondisi fit untuk menjalankan tugas',
        'Remarks', 
        'Selfie' // Ganti dari "Tanda Tangan"
      ];
      sheet.getRange(1, 1, 1, headers.length).setValues([headers]).setFontWeight('bold');
    }

    // 2. Upload Selfie ke Google Drive
    const base64Data = selfieDataUrl.split(',')[1];
    const decodedBlob = Utilities.newBlob(Utilities.base64Decode(base64Data), 'image/png', 'selfie.png');
    const folder = DriveApp.getFolderById(FOLDER_ID);
    
    const date = Utilities.formatDate(new Date(), ss.getSpreadsheetTimeZone(), 'yyyy-MM-dd');
    const fileName = `${date}_${formData.nama.replace(/[^a-zA-Z0-9]/g, '_')}_${formData.nrk}_selfie.png`;
    
    const selfieFile = folder.createFile(decodedBlob).setName(fileName);
    selfieFile.setSharing(DriveApp.Access.ANYONE, DriveApp.Permission.VIEW);
    const selfieUrl = selfieFile.getUrl();

    // 3. Persiapkan data untuk ditulis ke sheet
    const timestamp = Utilities.formatDate(new Date(), ss.getSpreadsheetTimeZone(), 'dd-MMM-yyyy HH:mm');
    const selfieHyperlink = `=HYPERLINK("${selfieUrl}"; "Lihat Selfie")`;

    const rowData = [
      timestamp,
      formData.nama,
      formData.nrk,
      formData.team,
      formData.Q1,
      formData.Q2,
      formData.Q3,
      formData.Q4,
      formData.Q5,
      formData.Q6,
      formData.Q7,
      formData.Q8,
      formData.Q9,
      formData.Q10,
      formData.Q11,
      formData.Q12,
      formData.Q13,
      formData.remarks,
      selfieHyperlink
    ];

    sheet.getRange(sheet.getLastRow() + 1, 1, 1, rowData.length).setValues([rowData]);

    return { success: true, url: selfieUrl };

  } catch (e) {
    Logger.log('Error in saveFitnessForm (Selfie): ' + e.toString());
    return { success: false, error: 'Gagal menyimpan data atau mengunggah selfie. Periksa Folder ID dan izin akses Drive. Detail: ' + e.toString() };
  }
}



/**
 * Menyimpan data Form Ijin Sakit (multiple dates) dan file Surat Sakit ke Google Drive dan Google Sheet.
 * File akan disimpan di folder Drive '1sxrnkZBDymGSlmKt7zV1d_B1q-hxQZYi'.
 * Data akan dicatat di Sheet 'Form Sakit'.
 * * @param {Object} formData Data form dari client (nama, team, sickDates: Array of 'YYYY-MM-DD').
 * @param {string} base64Data Data file yang dienkripsi Base64.
 * @param {string} uploadedFileName Nama file asli.
 * @param {string} uploadedFileMimeType MIME type file.
 * @return {Object} Status keberhasilan operasi.
 */
function saveSickLeaveForm(formData, base64Data, uploadedFileName, uploadedFileMimeType) {
  // Gunakan SPREADSHEET_ID yang sudah ada di code.gs Anda
  const SPREADSHEET_ID = '1VhLZVv8yZlqOOqj_TiH8ycetOQoEGYIJlyUCFFXA3vc'; 
  const SHEET_NAME_SICK = 'Form Sakit';
  // ID Folder Drive tujuan dari permintaan pengguna
  const DRIVE_FOLDER_ID = '1sxrnkZBDymGSlmKt7zV1d_B1q-hxQZYi';
  
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    let sheet = ss.getSheetByName(SHEET_NAME_SICK);
    const timezone = ss.getSpreadsheetTimeZone();
    
    // 1. Pastikan sheet 'Form Sakit' ada. Jika tidak, buat dan beri header.
    if (!sheet) {
      sheet = ss.insertSheet(SHEET_NAME_SICK);
      sheet.getRange('A1:E1').setValues([
        ['Timestamp', 'Nama', 'Tim', 'Tanggal Sakit', 'File Upload']
      ]).setFontWeight('bold');
    }

    // 2. Proses dan Simpan File ke Google Drive
    
    // a. Tanggal submit SPV (Awal nama file: 'yyyy-mm-dd')
    const dateSubmitted = Utilities.formatDate(new Date(), timezone, 'yyyy-MM-dd');
    
    // b. Tanggal sakit pertama (Akhir nama file: 'dd-mmm-yyyy')
    // sickDates sudah terurut karena diambil dari kalender Flatpickr
    const firstSickDateISO = formData.sickDates.length > 0 ? formData.sickDates[0] : ''; 
    const firstSickDate = new Date(firstSickDateISO); 
    const firstSickDateFormatted = Utilities.formatDate(firstSickDate, timezone, 'dd-MMM-yyyy');
    
    // c. Decode base64 menjadi Blob
    const decodedBlob = Utilities.newBlob(Utilities.base64Decode(base64Data), uploadedFileMimeType, uploadedFileName);
    
    // d. Buat nama file dan simpan
    const cleanName = formData.nama.replace(/[^a-zA-Z0-9 ]/g, '').replace(/ /g, '_'); 
    const fileExtension = uploadedFileName.substring(uploadedFileName.lastIndexOf('.'));
    const newFileName = `${dateSubmitted}_${cleanName}_${firstSickDateFormatted}`;

    const folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    const sickFile = folder.createFile(decodedBlob).setName(newFileName + fileExtension);
    
    // Agar bisa diakses via hyperlink, atur sharing
    sickFile.setSharing(DriveApp.Access.ANYONE, DriveApp.Permission.VIEW); 
    const fileUrl = sickFile.getUrl();

    // Buat formula HYPERLINK
    const fileHyperlink = `=HYPERLINK(\"${fileUrl}\"; \"Lampiran\")`;

    // 3. Persiapkan Data untuk Spreadsheet
    const timestamp = Utilities.formatDate(new Date(), timezone, 'dd-MMM-yyyy HH:mm:ss');

    const dataToAppend = [];
    
    // Setiap tanggal sakit akan menjadi baris baru (Kolom D)
    formData.sickDates.forEach(sickDateISO => {
      // Konversi tanggal sakit dari 'YYYY-MM-DD' ke 'dd-mmm-yyyy' untuk log
      const dateForLog = Utilities.formatDate(new Date(sickDateISO), timezone, 'dd-MMM-yyyy');
      
      const rowData = [
        timestamp,            // Kolom A: Timestamp
        formData.nama,        // Kolom B: Nama
        formData.team,        // Kolom C: Tim
        dateForLog,           // Kolom D: Tanggal Sakit (dd-mmm-yyyy)
        fileHyperlink         // Kolom E: File Upload (Hyperlink)
      ];
      dataToAppend.push(rowData);
    });
    
    // 4. Tulis semua baris data ke sheet sekaligus
    if (dataToAppend.length > 0) {
      sheet.getRange(sheet.getLastRow() + 1, 1, dataToAppend.length, dataToAppend[0].length).setValues(dataToAppend);
    }

    return { success: true, message: `Data ${dataToAppend.length} hari ijin sakit berhasil disimpan.` };

  } catch (e) {
    Logger.log('Error saat menyimpan Form Ijin Sakit: ' + e.toString());
    return { success: false, message: 'Gagal menyimpan data: ' + e.message + (e.message.includes('drive') ? ' (Pastikan ID Folder Drive sudah benar dan script memiliki izin Drive)' : '') };
  }
}
