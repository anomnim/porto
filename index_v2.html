<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Log MP TAM</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Konfigurasi Font Inter -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom scrollbar style */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #d1d5db;
            border-radius: 10px;
        }
        /* Style untuk radio button Ya/Tidak */
        .radio-group input:checked + label {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        .radio-group label {
            transition: all 0.2s;
        }
        /* Style untuk Canvas Tanda Tangan */
        #signature-canvas {
            border: 1px solid #ccc;
            touch-action: none; /* Penting untuk interaksi sentuh */
        }
        /* Style untuk Kalender */
        .date-picker-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
        }
        .date-cell {
            padding: 8px;
            cursor: pointer;
            border-radius: 50%;
            transition: background-color 0.1s;
        }
        .date-cell.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .date-cell.disabled {
            color: #ccc;
            cursor: not-allowed;
            background-color: transparent;
        }
        .date-cell:not(.disabled):hover {
            background-color: #e0e7ff; /* indigo-100 */
        }
        .date-cell.today {
            border: 2px solid #4f46e5;
        }
    </style>
    <!-- Script Apps Script untuk menyuntikkan data server (Asumsi data disuntikkan via template variable di Code.gs) -->
</head>
<body class="min-h-screen p-4 sm:p-8">
    
    <div class="max-w-4xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-indigo-700 mb-6 border-b pb-4">Activity Log MP TAM</h1>
        
        <!-- Informasi Supervisor & App ID (Dihapus sesuai permintaan) -->
        <div class="text-sm text-gray-500 mb-6 bg-red-100 p-3 rounded-lg">
            <p class="font-medium text-xs text-red-700">Peringatan: Fungsionalitas upload file ke Drive harus diselesaikan di Code.gs.</p>
        </div>

        <!-- Bagian Pemilihan Tim dan Karyawan -->
        <div id="employee-selection-section" class="space-y-6 mb-8 p-6 border border-gray-200 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-800">1. Pilih Karyawan</h2>
            
            <!-- Pemilihan Tim -->
            <div>
                <label for="team-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Tim</label>
                <select id="team-select" onchange="window.supervisorApp.selectTeam(this.value)" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                    <option value="" disabled selected>-- Pilih Tim --</option>
                    <!-- Opsi Tim akan diisi oleh JS berdasarkan data dari Code.gs -->
                </select>
            </div>
            
            <!-- Pemilihan Karyawan (Tergantung Tim) -->
            <div id="employee-lookup-container" class="hidden space-y-3">
                <label for="employee-search" class="block text-sm font-medium text-gray-700">Cari Nama Karyawan (Nama / NRK)</label>
                <input type="text" id="employee-search" oninput="window.supervisorApp.filterEmployees(this.value)" placeholder="Cari..." class="block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                
                <div id="employee-list-container" class="border border-gray-200 rounded-lg p-3 custom-scrollbar max-h-[160px] overflow-y-auto bg-gray-50">
                    <p class="text-sm text-gray-500" id="employee-list-message">Silakan pilih Tim terlebih dahulu.</p>
                    <ul id="employee-list" class="space-y-1">
                        <!-- Employee list will be rendered here -->
                    </ul>
                </div>
                
                <button id="show-more-btn" onclick="window.supervisorApp.toggleShowAllEmployees()" class="hidden text-indigo-600 hover:text-indigo-800 text-sm font-medium mt-1">
                    Lebih banyak...
                </button>
            </div>

             <!-- Karyawan yang Dipilih -->
            <div id="selected-employee-info" class="p-3 bg-indigo-100 border border-indigo-300 rounded-lg hidden">
                <p class="text-sm font-semibold text-indigo-700">Karyawan Dipilih:</p>
                <p class="text-lg font-bold text-indigo-900"><span id="selected-name"></span> (<span id="selected-nrk"></span>)</p>
                <button onclick="window.supervisorApp.resetEmployeeSelection()" class="text-xs text-red-500 hover:text-red-700 mt-1">Ubah Pilihan</button>
            </div>
        </div>

        <!-- Bagian Pemilihan Halaman Tujuan -->
        <div id="page-selection-section" class="space-y-4 p-6 bg-indigo-50 border border-indigo-200 rounded-xl">
            <h2 class="text-xl font-semibold text-gray-800">2. Pilih Halaman Tujuan</h2>
            <p class="text-sm text-gray-600">Pilih salah satu fungsi di bawah ini untuk Karyawan yang telah dipilih.</p>
            <div class="flex flex-col space-y-4 md:flex-row md:space-y-0 md:space-x-4">
                <button onclick="window.supervisorApp.selectPage('kelayakan')" id="btn-kelayakan" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50" disabled>
                    <span class="text-2xl">üìù</span> Form Kelayakan Kerja
                </button>
                <button onclick="window.supervisorApp.selectPage('sakit')" id="btn-sakit" class="flex-1 bg-indigo-600 text-white font-semibold py-3 px-4 rounded-xl shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50" disabled>
                    <span class="text-2xl">ü§í</span> Form Ijin Sakit & Upload Surat
                </button>
            </div>
        </div>

        <!-- Formulir Kelayakan Kerja (Page 1) -->
        <div id="page-kelayakan" class="mt-8 hidden p-6 border border-indigo-300 rounded-xl bg-white shadow-lg">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Form Kelayakan Kerja Karyawan</h2>
            <p class="text-sm text-gray-600 mb-6">Supervisor: Jawab pertanyaan di bawah ini dengan 'Ya' atau 'Tidak'.</p>
            <form id="form-kelayakan" onsubmit="window.supervisorApp.submitForm('kelayakan', event)" class="space-y-5">
                
                <div id="kelayakan-questions" class="space-y-5">
                    <!-- Pertanyaan akan dirender di sini oleh JavaScript -->
                </div>
                
                <!-- Field Keterangan Tambahan (Remarks) -->
                <div>
                    <label for="kelayakan-remarks" class="block text-sm font-medium text-gray-700 mb-1">Keterangan Tambahan (Maks. 500 Karakter)</label>
                    <textarea id="kelayakan-remarks" maxlength="500" rows="3" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Masukkan keterangan tambahan jika diperlukan..."></textarea>
                    <p class="text-xs text-gray-500 mt-1"><span id="remark-count">0</span>/500 karakter</p>
                </div>

                <!-- Field Tanda Tangan Karyawan -->
                <div class="pt-4 border-t border-gray-200">
                    <h3 class="text-base font-semibold text-gray-800 mb-2">Tanda Tangan Karyawan</h3>
                    <div class="p-2 border border-gray-300 rounded-lg bg-white shadow-inner">
                        <canvas id="signature-canvas" class="w-full" height="150"></canvas>
                    </div>
                    <div class="flex space-x-2 mt-2">
                        <button type="button" onclick="window.supervisorApp.clearSignature()" class="flex-1 bg-yellow-500 text-white text-sm py-2 rounded-md hover:bg-yellow-600 transition duration-300">
                            Hapus Tanda Tangan
                        </button>
                    </div>
                    <p class="text-xs text-red-500 mt-2" id="signature-error" style="display: none;">Harap masukkan tanda tangan sebelum mengirim.</p>
                </div>

                <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-green-700 transition duration-300">
                    Kirim Data Kelayakan Kerja
                </button>
            </form>
        </div>

        <!-- Formulir Ijin Sakit (Page 2) -->
        <div id="page-sakit" class="mt-8 hidden p-6 border border-indigo-300 rounded-xl bg-white shadow-lg">
            <h2 class="text-2xl font-bold text-indigo-700 mb-4">Form Ijin Sakit & Upload Surat</h2>
            <p class="text-sm text-gray-600 mb-6">Supervisor: Pilih tanggal sakit (bisa lebih dari satu) dan upload surat sakit karyawan.</p>
            <form id="form-sakit" onsubmit="window.supervisorApp.submitForm('sakit', event)" class="space-y-5">
                
                <!-- Bagian Pemilihan Tanggal Multi-Pilih -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Tanggal Ijin Sakit (Maks. H-1)</label>
                    <input type="hidden" id="sick-dates-hidden" required value="">
                    <div class="p-4 border border-gray-300 rounded-lg shadow-sm bg-white">
                        <div id="date-picker-header" class="flex justify-between items-center mb-3">
                            <button type="button" onclick="window.supervisorApp.navigateMonth(-1)" class="p-1 rounded-full hover:bg-gray-100">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                            </button>
                            <span id="current-month-year" class="font-semibold text-gray-800"></span>
                            <button type="button" onclick="window.supervisorApp.navigateMonth(1)" class="p-1 rounded-full hover:bg-gray-100">
                                <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                            </button>
                        </div>
                        <div id="date-picker-weekdays" class="date-picker-grid text-xs font-medium text-gray-500 mb-2">
                            <span>Min</span><span>Sen</span><span>Sel</span><span>Rab</span><span>Kam</span><span>Jum</span><span>Sab</span>
                        </div>
                        <div id="date-picker-body" class="date-picker-grid text-sm">
                            <!-- Cells will be rendered here -->
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Tanggal yang dipilih: <span id="selected-dates-display" class="font-mono text-indigo-600"></span></p>
                    <p class="text-xs text-red-500 mt-1" id="date-error" style="display: none;">Harap pilih setidaknya satu tanggal.</p>
                </div>

                <div>
                    <label for="sick-note-file" class="block text-sm font-medium text-gray-700 mb-1">Upload Surat Sakit (Dokter/Klinik)</label>
                    <input type="file" id="sick-note-file" accept=".pdf,image/*" capture="camera" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <p class="text-xs text-gray-500 mt-1">Max 10MB. File harus di-upload untuk membuat link 'Lampiran'.</p>
                </div>
                
                <button type="submit" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-xl shadow-lg hover:bg-red-700 transition duration-300">
                    Kirim Data Ijin Sakit
                </button>
            </form>
        </div>

        <!-- Message Box for Confirmation/Error (Using Modal/Toast pattern) -->
        <div id="message-box" class="fixed bottom-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-xl hidden transition-all duration-300 ease-out z-50 max-w-sm">
            <p id="message-text" class="font-semibold"></p>
            <button onclick="document.getElementById('message-box').classList.add('hidden')" class="ml-4 text-sm font-medium hover:text-gray-100">Tutup</button>
        </div>

    </div>

    <script type="text/javascript">
        // Global State and Logic
        window.supervisorApp = (function() {
            // --- KONSTANTA APLIKASI ---
            const MAX_FILE_SIZE_MB = 10;
            // Gunakan `google.script.run` untuk mendapatkan ID supervisor jika diperlukan,
            // tetapi untuk deployment "Execute as me", ID tidak ditampilkan di UI.
            const supervisorId = 'APPS_SCRIPT_USER'; 
            
            // Data disuntikkan oleh Code.gs melalui template variable
            // Pastikan employeeData didefinisikan pada template di Code.gs.
            const employeeDatabase = <?= JSON.stringify(employeeData || {}) ?>; 
            
            // --- STATE GLOBAL ---
            let selectedTeam = '';
            let selectedEmployee = null; 
            let currentFilter = '';
            let showAllEmployees = false;
            let selectedSickDates = new Set(); // Untuk multi-date picker
            let currentCalendarDate = new Date(); // Untuk kalender
            
            // --- Pertanyaan Kelayakan (Form Kelayakan) ---
            const kelayakanQuestions = [
                'Apakah tidur cukup (‚â•6 jam), dari jam berapa?',
                'Apakah merasa lelah berlebihan?',
                'Apakah mengalami sakit kepala / pusing?',
                'Apakah mengalami mual / gangguan pencernaan?',
                'Apakah ada keluhan nyeri otot / sendi?',
                'Apakah mengonsumsi obat-obatan yang bisa membuat ngantuk sebelum bekerja?',
                'Apakah mengonsumsi alkohol / zat terlarang dalam 24 jam terakhir?',
                'Apakah sedang dalam kondisi sakit (flu, batuk, demam, cedera)?',
                'Apakah ada gejala mengantuk berlebihan?',
                'Peralatan APD lengkap dan dipakai dengan benar',
                'Tidak ada gangguan penglihatan / pendengaran yang menghambat kerja',
                'Dalam kondisi fit untuk menjalankan tugas'
            ];

            // --- DOM Elements ---
            const $teamSelect = document.getElementById('team-select');
            const $employeeLookupContainer = document.getElementById('employee-lookup-container');
            const $employeeList = document.getElementById('employee-list');
            const $employeeListMessage = document.getElementById('employee-list-message');
            const $employeeSearch = document.getElementById('employee-search');
            const $showMoreBtn = document.getElementById('show-more-btn');
            const $selectedEmployeeInfo = document.getElementById('selected-employee-info');
            const $selectedName = document.getElementById('selected-name');
            const $selectedNRK = document.getElementById('selected-nrk');
            const $btnKelayakan = document.getElementById('btn-kelayakan');
            const $btnSakit = document.getElementById('btn-sakit');
            const $pageKelayakan = document.getElementById('page-kelayakan');
            const $pageSakit = document.getElementById('page-sakit');
            const $kelayakanQuestionsDiv = document.getElementById('kelayakan-questions');
            const $messageBox = document.getElementById('message-box');
            const $messageText = document.getElementById('message-text');
            const $remarksInput = document.getElementById('kelayakan-remarks');
            const $remarkCount = document.getElementById('remark-count');
            const $signatureError = document.getElementById('signature-error');
            
            // Calendar Elements
            const $currentMonthYear = document.getElementById('current-month-year');
            const $datePickerBody = document.getElementById('date-picker-body');
            const $selectedDatesDisplay = document.getElementById('selected-dates-display');
            const $sickDatesHidden = document.getElementById('sick-dates-hidden');
            const $dateError = document.getElementById('date-error');

            // Signature Canvas variables
            let canvas, ctx, isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            // --- Helper Functions ---
            function showMessage(text, isError = false) {
                $messageText.innerText = text;
                $messageBox.classList.remove('hidden');
                $messageBox.classList.remove('bg-green-500', 'bg-red-500');
                $messageBox.classList.add(isError ? 'bg-red-500' : 'bg-green-500');
                
                // Show then hide after 5 seconds
                $messageBox.style.opacity = '1';
                $messageBox.style.transform = 'translateY(0)';
                
                setTimeout(() => {
                    $messageBox.style.opacity = '0';
                    $messageBox.style.transform = 'translateY(20px)';
                    setTimeout(() => $messageBox.classList.add('hidden'), 300); // Wait for transition
                }, 5000);
            }

            function updateButtonsState() {
                const isDisabled = !selectedEmployee;
                $btnKelayakan.disabled = isDisabled;
                $btnSakit.disabled = isDisabled;
            }

            function hideAllPages() {
                $pageKelayakan.classList.add('hidden');
                $pageSakit.classList.add('hidden');
            }

            function resetEmployeeSelection() {
                selectedEmployee = null;
                selectedTeam = '';
                $teamSelect.value = '';
                document.getElementById('employee-search').value = '';
                $employeeLookupContainer.classList.add('hidden');
                $selectedEmployeeInfo.classList.add('hidden');
                hideAllPages();
                updateButtonsState();
                renderEmployeeList();
                showMessage('Pilihan karyawan direset.', false);
            }

            function renderEmployeeList() {
                if (!selectedTeam) {
                    $employeeListMessage.classList.remove('hidden');
                    $employeeListMessage.innerText = 'Silakan pilih Tim terlebih dahulu.';
                    $employeeList.innerHTML = '';
                    $showMoreBtn.classList.add('hidden');
                    return;
                }

                $employeeListMessage.classList.add('hidden');
                const teamData = employeeDatabase[selectedTeam] || [];
                const searchLower = currentFilter.toLowerCase();
                
                const filteredEmployees = teamData.filter(emp => 
                    emp.name.toLowerCase().includes(searchLower) || 
                    emp.nrk.toLowerCase().includes(searchLower)
                );

                const listToShow = (showAllEmployees || filteredEmployees.length <= 4) 
                    ? filteredEmployees 
                    : filteredEmployees.slice(0, 4);
                
                $employeeList.innerHTML = '';
                if (filteredEmployees.length === 0) {
                    $employeeListMessage.classList.remove('hidden');
                    $employeeListMessage.innerText = 'Tidak ada karyawan yang ditemukan.';
                }

                listToShow.forEach(emp => {
                    const li = document.createElement('li');
                    li.className = 'p-2 rounded-md hover:bg-indigo-100 cursor-pointer text-sm text-gray-800 transition duration-150';
                    li.innerHTML = `<span class="font-medium">${emp.name}</span> <span class="text-gray-500">(${emp.nrk})</span>`;
                    li.onclick = () => selectEmployee(emp);
                    $employeeList.appendChild(li);
                });

                if (filteredEmployees.length > 4) {
                    $showMoreBtn.classList.remove('hidden');
                    $showMoreBtn.innerText = showAllEmployees ? 'Sembunyikan' : `Lebih banyak... (${filteredEmployees.length - 4} lainnya)`;
                } else {
                    $showMoreBtn.classList.add('hidden');
                }
            }

            function filterEmployees(query) {
                currentFilter = query;
                showAllEmployees = false;
                renderEmployeeList();
            }

            function toggleShowAllEmployees() {
                showAllEmployees = !showAllEmployees;
                renderEmployeeList();
            }

            function selectEmployee(emp) {
                selectedEmployee = emp;
                $selectedName.innerText = emp.name;
                $selectedNRK.innerText = emp.nrk;
                $selectedEmployeeInfo.classList.remove('hidden');
                $employeeLookupContainer.classList.add('hidden'); 
                updateButtonsState();
                showMessage(`Karyawan ${emp.name} (${emp.nrk}) dipilih. Sekarang, pilih Halaman Tujuan.`);
            }

            function selectPage(page) {
                if (!selectedEmployee) {
                    showMessage('Harap pilih karyawan terlebih dahulu.', true);
                    return;
                }
                
                hideAllPages();
                if (page === 'kelayakan') {
                    $pageKelayakan.classList.remove('hidden');
                    initializeKelayakanForm(); 
                    showMessage('Mengisi Form Kelayakan Kerja.', false);
                } else if (page === 'sakit') {
                    $pageSakit.classList.remove('hidden');
                    initializeSickDateSelection();
                    showMessage('Mengisi Form Ijin Sakit.', false);
                }
            }
            
            // --- CALENDAR LOGIC (Multi-Date Picker) ---
            
            function initializeSickDateSelection() {
                selectedSickDates.clear(); // Reset pilihan tanggal
                currentCalendarDate = new Date(); // Reset kalender ke bulan saat ini
                renderCalendar();
                updateSickDateDisplay();
            }

            function getFormattedDateKey(date) {
                // Format YYYY-MM-DD
                const y = date.getFullYear();
                const m = String(date.getMonth() + 1).padStart(2, '0');
                const d = String(date.getDate()).padStart(2, '0');
                return `${y}-${m}-${d}`;
            }

            function navigateMonth(direction) {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + direction);
                renderCalendar();
            }

            function selectDate(dateKey) {
                const dateObj = new Date(dateKey);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                // Batas H-1 (Kemarin). Tanggal hari ini dan masa depan tidak bisa dipilih.
                if (dateObj >= today) {
                    showMessage('Tanggal yang dipilih tidak boleh hari ini atau masa depan (maksimal H-1).', true);
                    return;
                }

                if (selectedSickDates.has(dateKey)) {
                    selectedSickDates.delete(dateKey);
                } else {
                    selectedSickDates.add(dateKey);
                }
                renderCalendar(); // Render ulang untuk update tampilan
                updateSickDateDisplay();
                $dateError.style.display = selectedSickDates.size > 0 ? 'none' : 'block';
            }

            function updateSickDateDisplay() {
                const sortedDates = Array.from(selectedSickDates).sort();
                $selectedDatesDisplay.innerText = sortedDates.join(', ');
                $sickDatesHidden.value = sortedDates.join(','); // Update hidden field
            }
            
            function renderCalendar() {
                $datePickerBody.innerHTML = '';
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                
                const monthName = firstDay.toLocaleDateString('id-ID', { year: 'numeric', month: 'long' });
                $currentMonthYear.innerText = monthName;

                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1); // Batas maksimal H-1

                // Padding untuk hari pertama (0=Min, 1=Sen, ...)
                let dayOfWeek = firstDay.getDay(); // Sunday is 0, Monday is 1...
                let startPadding = dayOfWeek; // Jika hari pertama adalah Minggu, padding 0. Jika Senin, padding 1, dst.
                
                for (let i = 0; i < startPadding; i++) {
                    const emptyCell = document.createElement('div');
                    emptyCell.className = 'date-cell disabled';
                    $datePickerBody.appendChild(emptyCell);
                }

                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const date = new Date(year, month, day);
                    const dateKey = getFormattedDateKey(date);
                    const cell = document.createElement('div');
                    cell.innerText = day;
                    cell.classList.add('date-cell');

                    // Check disabled state (date > yesterday)
                    if (date > yesterday) {
                        cell.classList.add('disabled');
                    } else {
                        // Check selected state
                        if (selectedSickDates.has(dateKey)) {
                            cell.classList.add('selected');
                        }
                        // Add click listener
                        cell.onclick = () => selectDate(dateKey);
                    }
                    
                    // Check today indicator
                    if (dateKey === getFormattedDateKey(today)) {
                        cell.classList.add('today');
                    }
                    
                    $datePickerBody.appendChild(cell);
                }
            }
            
            // Signature Canvas Logic
            function setupSignatureCanvas() {
                canvas = document.getElementById('signature-canvas');
                ctx = canvas.getContext('2d');
                
                // Atur lebar canvas agar responsif
                const containerWidth = canvas.parentElement.clientWidth;
                canvas.width = containerWidth;
                
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 3;
                ctx.lineCap = 'round';
                
                const getCoords = (e) => {
                    const rect = canvas.getBoundingClientRect();
                    if (e.touches) {
                        return { 
                            x: e.touches[0].clientX - rect.left, 
                            y: e.touches[0].clientY - rect.top 
                        };
                    }
                    return { 
                        x: e.clientX - rect.left, 
                        y: e.clientY - rect.top 
                    };
                };

                const startDrawing = (e) => {
                    e.preventDefault();
                    isDrawing = true;
                    const { x, y } = getCoords(e);
                    [lastX, lastY] = [x, y];
                };

                const draw = (e) => {
                    if (!isDrawing) return;
                    e.preventDefault();
                    const { x, y } = getCoords(e);
                    
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                    [lastX, lastY] = [x, y];
                };

                const stopDrawing = () => {
                    isDrawing = false;
                };

                // Mouse events
                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);

                // Touch events
                canvas.addEventListener('touchstart', startDrawing);
                canvas.addEventListener('touchmove', draw);
                canvas.addEventListener('touchend', stopDrawing);

                clearCanvas();
            }
            
            function clearCanvas() {
                if (ctx && canvas) {
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    $signatureError.style.display = 'none';
                }
            }

            function getSignatureDataURL() {
                if (!canvas) return null;
                const dataUrl = canvas.toDataURL('image/png');
                
                // Buat canvas kosong untuk perbandingan
                const blankCanvas = document.createElement('canvas');
                blankCanvas.width = canvas.width;
                blankCanvas.height = canvas.height;
                const blankCtx = blankCanvas.getContext('2d');
                blankCtx.fillStyle = 'white';
                blankCtx.fillRect(0, 0, blankCanvas.width, blankCanvas.height);
                
                // Cek apakah data URL sama dengan data canvas kosong (artinya kosong)
                if (dataUrl === blankCanvas.toDataURL('image/png')) {
                    return null; 
                }
                
                return dataUrl;
            }
            
            // Kelayakan Form Setup
            function initializeKelayakanForm() {
                $kelayakanQuestionsDiv.innerHTML = kelayakanQuestions.map((q, index) => `
                    <div class="border p-4 rounded-lg bg-white shadow-sm">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">${index + 1}. ${q}</label>
                        <div class="radio-group flex space-x-4 mt-2">
                            <input type="radio" id="q${index}-ya" name="question_${index}" value="Ya" class="hidden" required>
                            <label for="q${index}-ya" class="flex-1 text-center py-2 px-4 rounded-lg cursor-pointer border border-indigo-400 text-indigo-700 hover:bg-indigo-100 font-medium">
                                Ya
                            </label>
                            
                            <input type="radio" id="q${index}-tidak" name="question_${index}" value="Tidak" class="hidden" required>
                            <label for="q${index}-tidak" class="flex-1 text-center py-2 px-4 rounded-lg cursor-pointer border border-indigo-400 text-indigo-700 hover:bg-indigo-100 font-medium">
                                Tidak
                            </label>
                        </div>
                    </div>
                `).join('');

                $remarksInput.addEventListener('input', () => {
                    $remarkCount.innerText = $remarksInput.value.length;
                });
                
                setupSignatureCanvas();
            }

            // --- Submission Helper Functions ---

            function formatDate(date, format) {
                const map = {
                    mm: date.getMonth() + 1,
                    dd: date.getDate(),
                    yyyy: date.getFullYear(),
                    HH: ('0' + date.getHours()).slice(-2),
                    MM: ('0' + date.getMinutes()).slice(-2)
                };
                
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
                
                let dateString = format;
                dateString = dateString.replace('dd', ('0' + map.dd).slice(-2));
                dateString = dateString.replace('mmm', monthNames[date.getMonth()]);
                dateString = dateString.replace('yyyy', map.yyyy);
                dateString = dateString.replace('hh', map.HH); 
                dateString = dateString.replace('mm', map.MM);
                dateString = dateString.replace('MM', ('0' + map.mm).slice(-2)); 
                
                return dateString;
            }

            // --- Submission Logic (REAL APPS SCRIPT CALL) ---

            async function submitForm(type, event) {
                event.preventDefault();
                
                if (!selectedEmployee) {
                    showMessage('Error: Pemilihan karyawan belum selesai.', true);
                    return;
                }
                
                const submitButton = event.target.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                
                // Set loading state
                submitButton.disabled = true;
                submitButton.innerHTML = 'Mengirim... <span class="animate-spin inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full"></span>';


                const submissionTime = new Date();
                
                const commonData = {
                    timestamp: submissionTime,
                    supervisorId: supervisorId, 
                    team: selectedTeam,
                    employeeName: selectedEmployee.name,
                    employeeNRK: selectedEmployee.nrk,
                };

                let sheetName = '';
                let gsheetData = null; 
                let signatureDataUrl = null; 
                let sickNoteFile = null; 

                // --- FORM KELAYAKAN LOGIC ---
                if (type === 'kelayakan') {
                    sheetName = 'Form Kelayakan';
                    
                    signatureDataUrl = getSignatureDataURL();
                    if (!signatureDataUrl) {
                        $signatureError.style.display = 'block';
                        showMessage('Harap masukkan tanda tangan karyawan.', true);
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                        return;
                    }
                    $signatureError.style.display = 'none';

                    let gsheetRowData = [];
                    // 1. Timestamp (A)
                    gsheetRowData.push(formatDate(submissionTime, 'dd-mmm-yyyy hh:mm')); 
                    // 2. Nama (B)
                    gsheetRowData.push(commonData.employeeName);
                    // 3. Tim (C)
                    gsheetRowData.push(commonData.team);

                    // 4. Pertanyaan D-O (12 Pertanyaan)
                    const formKelayakan = document.getElementById('form-kelayakan');
                    let allQuestionsAnswered = true;
                    kelayakanQuestions.forEach((q, index) => {
                        // Pastikan semua radio button untuk pertanyaan terjawab
                        const answer = formKelayakan.querySelector(`input[name="question_${index}"]:checked`)?.value;
                        if (!answer) {
                            allQuestionsAnswered = false;
                            return; // Stop processing this loop for the current question
                        }
                        gsheetRowData.push(answer);
                    });
                    
                    if (!allQuestionsAnswered) {
                        showMessage("Harap jawab semua pertanyaan kelayakan.", true);
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                        return;
                    }

                    if (gsheetRowData.length !== 15) { // 3 fields + 12 questions
                        // Ini akan menangani error jika ada pertanyaan yang belum dijawab
                        if (!formKelayakan.checkValidity()) {
                            showMessage("Harap lengkapi semua isian wajib di Form Kelayakan.", true);
                        }
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                        return;
                    }


                    // 5. Remarks (P)
                    const remarks = $remarksInput.value.trim();
                    gsheetRowData.push(remarks);

                    // 6. Tanda Tangan (Q) - Kirim placeholder, file diupload terpisah di Code.gs
                    const gsheetHyperlinkFormula = `=HYPERLINK("[FILE_ID_TANDA_TANGAN]", "Lihat Tanda Tangan ${commonData.employeeNRK}")`;
                    gsheetRowData.push(gsheetHyperlinkFormula);

                    gsheetData = gsheetRowData; // Sudah 17 kolom

                } 
                
                // --- FORM IJIN SAKIT LOGIC ---
                else if (type === 'sakit') {
                    sheetName = 'Form Sakit';
                    const fileInput = document.getElementById('sick-note-file');
                    
                    // 1. Validasi Input Tanggal
                    const dates = $sickDatesHidden.value.split(',').filter(d => d.trim() !== '').sort();

                    if (dates.length === 0) {
                        $dateError.style.display = 'block';
                        showMessage('Harap pilih setidaknya satu Tanggal Ijin Sakit.', true);
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                        return;
                    }
                    $dateError.style.display = 'none';

                    // 2. Validasi File Upload (Opsional, tapi jika diisi harus valid)
                    let fileHyperlinkFormula = 'N/A (Tidak Ada Lampiran)';
                    
                    if (fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                            showMessage(`Ukuran file melebihi batas ${MAX_FILE_SIZE_MB}MB.`, true);
                            submitButton.disabled = false;
                            submitButton.innerHTML = originalButtonText;
                            return;
                        }
                        sickNoteFile = file;
                        // Placeholder link. Akan diupdate oleh Code.gs
                        fileHyperlinkFormula = `=HYPERLINK("[FILE_ID_SURAT_SAKIT]", "Lampiran")`;
                    }
                    
                    // 3. Generate Multiple Rows (Array 2D)
                    const submissionTimestamp = formatDate(submissionTime, 'dd-mmm-yyyy hh:mm');
                    gsheetData = [];

                    dates.forEach(dateStr => {
                        // Pastikan format tanggal yyyy-mm-dd untuk konversi yang benar
                        const dateParts = dateStr.split('-');
                        // Tanggal harus dikonversi dengan hati-hati untuk menghindari masalah timezone
                        // Gunakan new Date(year, monthIndex, day)
                        const sickDate = new Date(parseInt(dateParts[0]), parseInt(dateParts[1]) - 1, parseInt(dateParts[2]));
                        const sickDateFormatted = formatDate(sickDate, 'dd-mmm-yyyy');
                        
                        // Kolom A, B, C, D, E
                        const row = [
                            submissionTimestamp, 
                            commonData.employeeName, 
                            commonData.team,
                            sickDateFormatted, // D: Tanggal Sakit (dd-mmm-yyyy)
                            fileHyperlinkFormula 
                        ];
                        gsheetData.push(row);
                    });
                }
                
                // 4. Call Apps Script Server Function
                const payload = {
                    sheetName: sheetName,
                    data: gsheetData, 
                    // Data tambahan untuk upload file
                    signatureDataUrl: type === 'kelayakan' ? signatureDataUrl : null,
                    sickNoteFileName: type === 'sakit' && sickNoteFile ? sickNoteFile.name : null,
                    employeeNRK: commonData.employeeNRK
                };

                // Untuk upload file (Surat Sakit), Apps Script memerlukan data file dikirim sebagai parameter terpisah
                if (sickNoteFile) {
                    google.script.run
                        .withSuccessHandler(handleSuccess)
                        .withFailureHandler(handleFailure)
                        .processFormSubmissionWithFile(payload, sickNoteFile); 
                } else {
                    google.script.run
                        .withSuccessHandler(handleSuccess)
                        .withFailureHandler(handleFailure)
                        .processFormSubmission(payload);
                }
                
                function handleSuccess(response) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;

                    showMessage(response.message);
                    document.getElementById(`form-${type}`).reset();
                    // Reset kalender setelah sukses submit
                    if (type === 'sakit') {
                         initializeSickDateSelection();
                    }
                    hideAllPages();
                    resetEmployeeSelection();
                    clearCanvas();
                }

                function handleFailure(error) {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;

                    showMessage(`Error: ${error.message || error}`, true);
                    console.error("Apps Script Error:", error);
                }
            }
            
            function selectTeam(team) {
                selectedTeam = team;
                $employeeLookupContainer.classList.remove('hidden');
                $employeeSearch.value = '';
                currentFilter = '';
                showAllEmployees = false;
                renderEmployeeList();
            }


            // --- Initialization ---

            function populateTeamSelect() {
                const teams = Object.keys(employeeDatabase).sort();
                teams.forEach(team => {
                    const option = document.createElement('option');
                    option.value = team;
                    option.innerText = team;
                    $teamSelect.appendChild(option);
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
                populateTeamSelect();
                renderEmployeeList();
                updateButtonsState();
                // Inisialisasi kalender saat DOM siap
                initializeSickDateSelection(); 
            });


            // Expose public methods
            return {
                selectTeam,
                filterEmployees,
                toggleShowAllEmployees,
                selectEmployee,
                resetEmployeeSelection,
                selectPage,
                submitForm,
                clearSignature: clearCanvas,
                // Calendar methods
                navigateMonth,
                selectDate,
            };
        })();
    </script>
</body>
</html>
