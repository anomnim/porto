<!-- Activity Log MP - Full Web App HTML + JS
     Modifikasi: ganti tanda tangan dengan selfie realtime (kamera depan).
     Foto diset ke 720x1280 JPG kualitas 80%.
-->
<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Activity Log MP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background-color: #f7f9fc; }
    .card-shadow { box-shadow: 0 10px 15px -3px rgba(0,0,0,.05), 0 4px 6px -2px rgba(0,0,0,.03); }
    .team-button.active { border: 3px solid #2b39ff !important; box-shadow: 0 0 0 3px rgba(147,197,253,.3) !important; }
    /* Perbaikan ratio video untuk mobile */
    #video { background: #000; object-fit: cover; }
  </style>
</head>
<body>
  <div id="app-container" class="min-h-screen px-2 py-4 sm:p-8 sm:py-8 flex items-start sm:items-center justify-center">
    <div class="w-full max-w-2xl bg-white p-2 sm:p-10 rounded-none sm:rounded-xl card-shadow border border-gray-200 mt-4 sm:mt-0">
      <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">Activity Log MP</h1>
      <p class="text-center text-gray-500 mb-8" id="app-intro">Silakan pilih tim dan nama karyawan.</p>

      <div id="loading" class="hidden text-center p-4">
        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div>
        <p class="mt-2 text-indigo-600">Memuat data...</p>
      </div>

      <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6" role="alert">
        <strong class="font-bold">Error!</strong>
        <span id="error-text" class="block sm:inline ml-2"></span>
      </div>

      <div id="main-form"></div>
    </div>
  </div>

<script>
// ---------- Global state ----------
let allEmployees = [];
let selectedEmployee = null;
let selectedTeam = '';

// Selfie state
let selfieDataUrl = null; // data URL JPEG 720x1280 quality 0.8
let videoStream = null;

// Sick leave state (unchanged)
let selectedSickDates = new Set();
let currentCalendarDate = new Date();
let uploadedFileBase64 = null;
let uploadedFileName = null;
let uploadedFileMimeType = null;
const MAX_FILE_SIZE_BYTES = 10 * 1024 * 1024; // 10MB

// ---------- Utilities ----------
function showLoading(){ document.getElementById('main-form').classList.add('hidden'); document.getElementById('loading').classList.remove('hidden'); hideError(); }
function hideLoading(){ document.getElementById('main-form').classList.remove('hidden'); document.getElementById('loading').classList.add('hidden'); }
function showError(msg){ document.getElementById('error-text').textContent = msg; document.getElementById('error-message').classList.remove('hidden'); }
function hideError(){ document.getElementById('error-message').classList.add('hidden'); }
function toggleNavButtons(disabled){ const nav1 = document.getElementById('nav-page-1'); const nav2 = document.getElementById('nav-page-2'); if(nav1) nav1.disabled = disabled; if(nav2) nav2.disabled = disabled; }

function clearEmployeeDetails(){ selectedEmployee = null; const detailsCard = document.getElementById('employee-details-card'); const employeeInput = document.getElementById('employee-input'); const filteredList = document.getElementById('filtered-list'); if(detailsCard) detailsCard.classList.add('hidden'); const detailNrk = document.getElementById('detail-nrk'); const detailNama = document.getElementById('detail-nama'); const detailPenempatan = document.getElementById('detail-penempatan'); if(detailNrk) detailNrk.textContent = ''; if(detailNama) detailNama.textContent = ''; if(detailPenempatan) detailPenempatan.textContent = ''; if(employeeInput) employeeInput.value = ''; if(employeeInput) employeeInput.disabled = false; if(filteredList) filteredList.classList.add('hidden'); toggleNavButtons(true); }

// ---------- Apps Script callbacks ----------
function onEmployeesLoad(response){ hideLoading(); clearEmployeeDetails(); const employeeInput = document.getElementById('employee-input'); if(response.success){ allEmployees = response.data; if(allEmployees.length === 0){ showError('Tidak ada karyawan ditemukan untuk tim ini.'); employeeInput.disabled = true; } else { employeeInput.disabled = false; employeeInput.focus(); if(employeeInput.value){ handleInputFilter(employeeInput.value); } } } else { showError(response.error); employeeInput.disabled = true; allEmployees = []; } }

function onSaveSuccess(response){ hideLoading(); if(response.success){ const container = document.getElementById('app-container').querySelector('div'); const formType = response.formType || 'Form'; const fileUrlHtml = response.url ? `<p class="text-lg text-gray-600 mb-6">${formType} telah disimpan ke Google Sheet. <a href="${response.url}" target="_blank" class="text-indigo-600 hover:underline">Lihat File</a></p>` : `<p class="text-lg text-gray-600 mb-6">${formType} telah disimpan ke Google Sheet.</p>`; container.innerHTML = `<div class="p-8 text-center"><h2 class="text-3xl font-bold text-green-600 mb-4">Data Berhasil Disimpan!</h2>${fileUrlHtml}<button onclick="renderLandingPage()" class="mt-8 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg">&larr; Kembali ke Landing Page</button></div>`; // reset state
selectedEmployee = null; selectedTeam = ''; allEmployees = []; selfieDataUrl = null; if(videoStream){ stopCamera(); } document.getElementById('app-intro').classList.remove('hidden'); } else { showError('Gagal menyimpan data: ' + response.error); // re-render the relevant form
 if(response.formType === 'Pemeriksaan Harian') renderFitnessForm(); else if(response.formType === 'Izin Sakit') renderSickLeaveForm(); } }

// ---------- Landing page rendering ----------
function renderLandingPage(){ // reset selfie state when going back
 selfieDataUrl = null; if(videoStream){ stopCamera(); }
 selectedSickDates.clear(); currentCalendarDate = new Date(); uploadedFileBase64 = null; uploadedFileName = null; uploadedFileMimeType = null;
 const mainFormContainer = document.getElementById('main-form'); if(!mainFormContainer){ const appContainer = document.getElementById('app-container'); appContainer.innerHTML = ` <div class="w-full max-w-2xl bg-white p-6 sm:p-10 rounded-xl card-shadow border border-gray-200 mt-8 sm:mt-0"> <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-6 text-center">Activity Log MP</h1> <p class="text-center text-gray-500 mb-8" id="app-intro">Silakan pilih tim dan nama karyawan.</p> <div id="loading" class="hidden text-center p-4"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto"></div><p class="mt-2 text-indigo-600">Memuat data...</p></div> <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6" role="alert"><strong class="font-bold">Error!</strong><span id="error-text" class="block sm:inline ml-2"></span></div> <div id="main-form"></div> </div>`; }
 const targetContainer = document.getElementById('main-form'); if(!targetContainer) return;
 const redActive = selectedTeam === 'Red' ? ' active' : '';
 const whiteActive = selectedTeam === 'White' ? ' active' : '';
 const landingHtml = `
 <div id="landing-page-content">
  <div class="mb-6">
    <label class="block text-gray-700 text-sm font-bold mb-3">Pilih Tim Karyawan:</label>
    <div class="flex gap-4">
      <button id="team-red-button" onclick="handleTeamChange('Red')" class="team-button flex-1 font-bold py-3 px-4 rounded-lg focus:outline-none transition duration-150 ${redActive} bg-red-600 text-white hover:bg-red-700">Tim Red</button>
      <button id="team-white-button" onclick="handleTeamChange('White')" class="team-button flex-1 font-bold py-3 px-4 rounded-lg focus:outline-none transition duration-150 ${whiteActive} bg-white text-red-600 border-2 border-red-600 hover:bg-red-50">Tim White</button>
    </div>
  </div>

  <div class="mb-6 relative">
    <label for="employee-input" class="block text-gray-700 text-sm font-bold mb-2">Pilih Karyawan (Nama (NRK)):</label>
    <input id="employee-input" type="text" placeholder="Ketik nama atau NRK karyawan..." autocomplete="off" oninput="handleInputFilter(this.value)" class="shadow appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" disabled>
    <div id="autocomplete-results" class="relative">
      <ul id="filtered-list" class="absolute z-10 w-full bg-white border border-gray-300 rounded-b-lg shadow-lg max-h-48 overflow-y-auto hidden"></ul>
    </div>
  </div>

  <div id="employee-details-card" class="bg-indigo-50 p-6 rounded-xl border border-indigo-200 hidden mb-8 card-shadow">
    <h3 class="text-xl font-semibold text-indigo-800 mb-3 border-b pb-2 border-indigo-300">Detail Karyawan</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
      <div><strong class="text-gray-600 block">NRK Karyawan:</strong> <span id="detail-nrk" class="text-gray-900 font-medium"></span></div>
      <div><strong class="text-gray-600 block">Nama Karyawan:</strong> <span id="detail-nama" class="text-gray-900 font-medium"></span></div>
      <div class="md:col-span-2"><strong class="text-gray-600 block">Penempatan Karyawan:</strong> <span id="detail-penempatan" class="text-gray-900 font-medium"></span></div>
    </div>
  </div>

  <div class="flex flex-col sm:flex-row gap-4">
    <button id="nav-page-1" onclick="navigateToPage(1, 'Pemeriksaan Harian')" class="nav-button flex-1 bg-indigo-600 text-white font-bold py-3 px-6 rounded-lg" disabled>Pemeriksaan Harian</button>
    <button id="nav-page-2" onclick="navigateToPage(2, 'Izin Sakit')" class="nav-button flex-1 bg-green-600 text-white font-bold py-3 px-6 rounded-lg" disabled>Izin Sakit</button>
  </div>
 </div>
 `;
 targetContainer.innerHTML = landingHtml; document.getElementById('app-intro').classList.remove('hidden'); clearEmployeeDetails(); const redBtn = document.getElementById('team-red-button'); const whiteBtn = document.getElementById('team-white-button'); if(redBtn) redBtn.classList.toggle('active', selectedTeam === 'Red'); if(whiteBtn) whiteBtn.classList.toggle('active', selectedTeam === 'White'); }

// ---------- Landing page handlers ----------
function handleTeamChange(teamName){ const allTeamButtons = document.querySelectorAll('.team-button'); allTeamButtons.forEach(btn => btn.classList.remove('active')); if(!teamName){ clearEmployeeDetails(); selectedTeam = ''; return; } const selectedBtn = document.getElementById(`team-${teamName.toLowerCase()}-button`); if(selectedBtn) selectedBtn.classList.add('active'); if(selectedTeam === teamName && allEmployees.length>0) return; selectedTeam = teamName; showLoading(); clearEmployeeDetails(); google.script.run.withSuccessHandler(onEmployeesLoad).withFailureHandler(function(error){ hideLoading(); showError('Gagal menghubungi server Apps Script: ' + (error.message||error)); }).getEmployees(teamName); }

function handleInputFilter(inputText){ const input = inputText.toLowerCase().trim(); const listElement = document.getElementById('filtered-list'); listElement.innerHTML = ''; if(input.length===0 && selectedEmployee){ listElement.classList.add('hidden'); return; } const filteredEmployees = allEmployees.filter(emp => emp.display.toLowerCase().includes(input)); if(filteredEmployees.length===0){ listElement.classList.add('hidden'); return; } const itemsToShow = Math.min(3, filteredEmployees.length); for(let i=0;i<itemsToShow;i++){ const emp = filteredEmployees[i]; const li = document.createElement('li'); li.className = 'p-3 cursor-pointer hover:bg-indigo-100 transition duration-150 text-gray-800 text-sm border-b border-gray-100 last:border-b-0'; li.textContent = emp.display; li.onclick = () => selectEmployee(emp); listElement.appendChild(li); } if(filteredEmployees.length>3){ const moreLi = document.createElement('li'); moreLi.className = 'p-3 text-center text-indigo-600 font-semibold cursor-pointer hover:bg-indigo-50 text-sm'; moreLi.textContent = `... Lihat ${filteredEmployees.length-3} lainnya ...`; moreLi.onclick = () => showAllResults(filteredEmployees); listElement.appendChild(moreLi); } listElement.classList.remove('hidden'); }
function showAllResults(allResults){ const listElement = document.getElementById('filtered-list'); listElement.innerHTML = ''; allResults.forEach(emp=>{ const li=document.createElement('li'); li.className='p-3 cursor-pointer hover:bg-indigo-100 transition duration-150 text-gray-800 text-sm border-b border-gray-100 last:border-b-0'; li.textContent = emp.display; li.onclick = () => selectEmployee(emp); listElement.appendChild(li); }); }
function selectEmployee(employee){ selectedEmployee = employee; document.getElementById('employee-input').value = employee.display; document.getElementById('filtered-list').classList.add('hidden'); document.getElementById('detail-nrk').textContent = employee.nrk; document.getElementById('detail-nama').textContent = employee.nama; document.getElementById('detail-penempatan').textContent = employee.penempatan; document.getElementById('employee-details-card').classList.remove('hidden'); toggleNavButtons(false); }

// ---------- Pemeriksaan Harian (Fitness Form) ----------
const formQuestions = [ { id: 'Q1', text: 'Apakah tidur cukup (≥6 jam)?' }, { id: 'Q2', text: 'Apakah merasa lelah berlebihan?' }, { id: 'Q3', text: 'Apakah ada gejala mengantuk berlebihan?' }, { id: 'Q4', text: 'Apakah sebelumnya lembur lebih dari 12 jam?' }, { id: 'Q5', text: 'Apakah mengalami sakit kepala / pusing?' }, { id: 'Q6', text: 'Apakah mengalami mual / gangguan pencernaan?' }, { id: 'Q7', text: 'Apakah ada keluhan nyeri otot / sendi?' }, { id: 'Q8', text: 'Apakah sedang dalam kondisi sakit (flu, batuk, demam, cedera)?' }, { id: 'Q9', text: 'Apakah mengonsumsi obat-obatan sebelum bekerja?' }, { id: 'Q10', text: 'Apakah mengonsumsi alkohol / zat terlarang dalam 24 jam terakhir?' }, { id: 'Q11', text: 'Apakah ada gangguan penglihatan / pendengaran yang menghambat kerja' }, { id: 'Q12', text: 'Apakah Peralatan APD lengkap dan dipakai dengan benar' }, { id: 'Q13', text: 'Apakah dalam kondisi fit untuk melakukan tugas?' } ];

function renderFitnessForm(){ const mainFormContainer = document.getElementById('main-form'); document.getElementById('app-intro').classList.add('hidden'); let formHtml = `
  <h2 class="text-2xl font-bold text-indigo-700 mb-6 text-center">Pemeriksaan Harian</h2>
  <div class="mb-6 p-4 border border-indigo-200 rounded-lg bg-indigo-50">
    <p class="text-sm font-semibold text-indigo-800">Karyawan: ${selectedEmployee.nama} (NRK: ${selectedEmployee.nrk})</p>
    <p class="text-xs text-indigo-600">Tim: ${selectedTeam}</p>
  </div>

  <form id="fitness-form" onsubmit="event.preventDefault(); submitFitnessForm();">
    <div class="space-y-4 mb-6">
`;
 formQuestions.forEach((q,index)=>{ const questionText = q.id==='Q1' ? q.text + ' (dapat diisi detail jam di Keterangan Tambahan)' : q.text; formHtml += `
  <div class="bg-white p-4 rounded-lg border">
    <label class="block text-gray-700 font-medium mb-2">${index+1}. ${questionText}</label>
    <div class="flex space-x-4">
      <label class="inline-flex items-center">
        <input type="radio" name="${q.id}" value="Ya" class="form-radio h-4 w-4 text-green-600 required-radio" required>
        <span class="ml-2 text-gray-700">Ya</span>
      </label>
      <label class="inline-flex items-center">
        <input type="radio" name="${q.id}" value="Tidak" class="form-radio h-4 w-4 text-red-600 required-radio" required>
        <span class="ml-2 text-gray-700">Tidak</span>
      </label>
    </div>
  </div>
` });
 formHtml += `
    </div>
    <div class="mb-8">
      <label for="remarks" class="block text-gray-700 font-bold mb-2">Keterangan Tambahan (Maks. 500 karakter):</label>
      <textarea id="remarks" maxlength="500" placeholder="Isi di sini jika ada keterangan tambahan, termasuk detail jam tidur (misal: 23:00-05:00)." class="shadow border rounded w-full py-3 px-4 leading-tight h-24"></textarea>
      <p class="text-xs text-gray-500 mt-1"><span id="char-count">0</span>/500 karakter</p>
    </div>

    <!-- Selfie (ganti signature) -->
    <div class="mb-8 p-4 border rounded-lg bg-gray-50">
      <label class="block text-gray-700 font-bold mb-2">Foto Selfie Karyawan (harus diambil realtime):</label>
      <div id="camera-area" class="w-full">
        <video id="video" autoplay playsinline class="w-full rounded-lg" style="height:640px; max-height:70vh; object-fit:cover;"></video>
        <canvas id="selfie-canvas" width="720" height="1280" class="hidden"></canvas>
        <div class="mt-3 flex gap-3">
          <button type="button" onclick="captureSelfie()" id="capture-selfie-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">📸 Ambil Selfie</button>
          <button type="button" onclick="clearCapturedSelfie()" id="clear-selfie-btn" class="bg-red-100 text-red-700 px-4 py-2 rounded-lg">Hapus Foto</button>
        </div>
        <img id="selfie-preview" class="hidden mt-3 rounded-lg border" alt="preview selfie" />
        <p class="text-xs text-gray-500 mt-2">Catatan: Foto harus diambil menggunakan kamera (bukan diunggah dari galeri).</p>
      </div>
    </div>

    <button type="submit" id="save-button" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg">Simpan Data Form Kelayakan</button>
    <button type="button" onclick="renderLandingPage()" class="w-full mt-3 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg">&larr; Kembali ke Landing Page</button>
  </form>
`;
 mainFormContainer.innerHTML = formHtml;
 initializeCameraForSelfie();
 const remarksTextarea = document.getElementById('remarks'); if(remarksTextarea){ remarksTextarea.addEventListener('input', (e)=>{ document.getElementById('char-count').textContent = e.target.value.length; }); }
}

// Camera helpers (selfie)
async function initializeCameraForSelfie(){ selfieDataUrl = null; const video = document.getElementById('video'); const canvas = document.getElementById('selfie-canvas'); const preview = document.getElementById('selfie-preview'); try{ // prefer front camera
 video.autoplay = true; video.playsInline = true; const constraints = { video: { facingMode: { ideal: 'user' }, width: { ideal: 720 }, height: { ideal: 1280 } } };
 videoStream = await navigator.mediaDevices.getUserMedia(constraints);
 video.srcObject = videoStream; } catch(err){ console.error('Gagal akses kamera:', err); showError('Tidak dapat mengakses kamera. Pastikan izin kamera diberikan dan perangkat memiliki kamera depan.'); }
}

function stopCamera(){ if(videoStream){ const tracks = videoStream.getTracks(); tracks.forEach(t => t.stop()); videoStream = null; } }

function captureSelfie(){ hideError(); const video = document.getElementById('video'); const canvas = document.getElementById('selfie-canvas'); const preview = document.getElementById('selfie-preview'); if(!video || !canvas) return; // draw image filling canvas while preserving aspect via drawImage
 const ctx = canvas.getContext('2d'); // Ensure we draw the centered crop from video to match 720x1280
 const vw = video.videoWidth; const vh = video.videoHeight; if(!vw || !vh){ showError('Kamera belum siap. Tunggu beberapa saat lalu coba lagi.'); return; }
 // We want to crop/scale the video into 720x1280 canvas. video may be landscape on desktop; compute source rect centered
 const targetW = canvas.width; const targetH = canvas.height; //720x1280
 // compute scale to cover
 const scale = Math.max(targetW / vw, targetH / vh);
 const sw = targetW / scale; const sh = targetH / scale;
 const sx = Math.max(0, (vw - sw) / 2); const sy = Math.max(0, (vh - sh) / 2);
 ctx.clearRect(0,0,canvas.width,canvas.height);
 ctx.drawImage(video, sx, sy, sw, sh, 0, 0, targetW, targetH);
 // convert to JPEG quality 0.8
 canvas.toBlob(function(blob){ if(!blob){ showError('Gagal membuat file foto.'); return; }
 const reader = new FileReader(); reader.onloadend = function(){ selfieDataUrl = reader.result; preview.src = selfieDataUrl; preview.classList.remove('hidden'); document.getElementById('save-button').disabled = false; };
 reader.readAsDataURL(blob);
 }, 'image/jpeg', 0.8);
}

function clearCapturedSelfie(){ selfieDataUrl = null; const preview = document.getElementById('selfie-preview'); if(preview){ preview.src = ''; preview.classList.add('hidden'); } }

// submit fitness -> send selfieDataUrl instead of signature
function submitFitnessForm(){ hideError(); if(!selectedEmployee || !selectedTeam){ showError('Sesi karyawan hilang. Harap kembali ke landing page.'); return; }
 if(!selfieDataUrl){ showError('Harap ambil foto selfie karyawan terlebih dahulu.'); return; }
 const form = document.getElementById('fitness-form'); const formData = { nama: selectedEmployee.nama, team: selectedTeam, nrk: selectedEmployee.nrk, remarks: document.getElementById('remarks').value, formType: 'Pemeriksaan Harian' };
 let isFormValid = true; formQuestions.forEach(q=>{ const selectedValue = form.elements[q.id]?.value; if(!selectedValue) isFormValid = false; formData[q.id] = selectedValue; }); if(!isFormValid){ showError('Harap jawab semua 13 pertanyaan Kelayakan Kerja.'); return; }
 // send
 showLoading(); google.script.run.withSuccessHandler(onSaveSuccess).withFailureHandler(function(error){ hideLoading(); showError('Gagal menghubungi Apps Script untuk menyimpan data: ' + (error.message||error)); }).saveFitnessForm(formData, selfieDataUrl);
}

// ---------- Izin Sakit (unchanged except reuse render functions) ----------
const MONTH_NAMES = ["Januari","Februari","Maret","April","Mei","Juni","Juli","Agustus","September","Oktober","November","Desember"];
const DAY_NAMES_SHORT = ["Min","Sen","Sel","Rab","Kam","Jum","Sab"];
function formatDateString(date){ const y=date.getFullYear(); const m=String(date.getMonth()+1).padStart(2,'0'); const d=String(date.getDate()).padStart(2,'0'); return `${y}-${m}-${d}`; }
function formatOutputDate(dateString){ const [year,month,day]=dateString.split('-'); const monthIndex = parseInt(month,10)-1; return `${day}-${MONTH_NAMES[monthIndex].substring(0,3)}-${year}`; }
function isSelectable(date){ const today=new Date(); today.setHours(0,0,0,0); const yesterday=new Date(today); yesterday.setDate(today.getDate()-1); const checkDate=new Date(date.getTime()); checkDate.setHours(0,0,0,0); return checkDate>=yesterday; }
function renderCalendar(){ const year=currentCalendarDate.getFullYear(); const month=currentCalendarDate.getMonth(); const calendarContainer=document.getElementById('calendar-grid'); const monthDisplay=document.getElementById('month-display'); if(!calendarContainer||!monthDisplay) return; monthDisplay.textContent = `${MONTH_NAMES[month]} ${year}`; calendarContainer.innerHTML=''; const firstDayOfMonth=new Date(year,month,1); const lastDayOfMonth=new Date(year,month+1,0); const startingDay = firstDayOfMonth.getDay(); let headerHtml = `<div class="grid grid-cols-7 text-center font-bold text-gray-500 mb-2">`; DAY_NAMES_SHORT.forEach(day=>{ headerHtml += `<span class="text-xs">${day}</span>`; }); headerHtml += `</div>`; calendarContainer.innerHTML += headerHtml; let daysHtml = `<div class="grid grid-cols-7 text-center">`; for(let i=0;i<startingDay;i++){ daysHtml += `<div class="day-cell"></div>`; } for(let d=1; d<= lastDayOfMonth.getDate(); d++){ const currentDate = new Date(year,month,d); const dateString = formatDateString(currentDate); let classes = 'day-cell'; const available = isSelectable(currentDate); if(selectedSickDates.has(dateString)){ classes += ' selected'; } else if(available){ classes += ' available text-gray-800'; } else { classes += ' unavailable'; } const clickHandler = available ? `onclick="toggleDateSelection('${dateString}')"` : ''; daysHtml += `<div class="${classes}" ${clickHandler}>${d}</div>`; } daysHtml += `</div>`; calendarContainer.innerHTML += daysHtml; updateSelectedDatesList(); }
function changeMonth(delta){ currentCalendarDate.setMonth(currentCalendarDate.getMonth()+delta); renderCalendar(); }
function toggleDateSelection(dateString){ if(selectedSickDates.has(dateString)) selectedSickDates.delete(dateString); else selectedSickDates.add(dateString); renderCalendar(); }
function updateSelectedDatesList(){ const listContainer = document.getElementById('selected-dates-list'); if(!listContainer) return; const datesArray = Array.from(selectedSickDates).sort(); if(datesArray.length===0){ listContainer.innerHTML = `<p class="text-sm text-gray-500 italic">Belum ada tanggal sakit yang dipilih.</p>`; return; } let listHtml = `<ul class="space-y-1">`; datesArray.forEach(dateString=>{ listHtml += `<li class="text-gray-700 text-sm font-medium flex justify-between items-center bg-gray-50 p-2 rounded"><span>${formatOutputDate(dateString)}</span><button type="button" onclick="toggleDateSelection('${dateString}')" class="text-red-500 hover:text-red-700 text-lg leading-none">&times;</button></li>`; }); listHtml += `</ul>`; listContainer.innerHTML = listHtml; }

function handleSickLeaveFileUpload(event){ uploadedFileBase64=null; uploadedFileName=null; uploadedFileMimeType=null; const file = event.target.files[0]; const fileStatus = document.getElementById('file-upload-status'); if(!file){ fileStatus.innerHTML = '<span class="text-red-500">Tidak ada file yang dipilih.</span>'; return; } if(file.size > MAX_FILE_SIZE_BYTES){ fileStatus.innerHTML = `<span class="text-red-500">Ukuran file melebihi ${MAX_FILE_SIZE_BYTES/1024/1024}MB.</span>`; event.target.value=''; return; } const reader = new FileReader(); reader.onload = function(e){ uploadedFileBase64 = e.target.result.split(',')[1]; uploadedFileName = file.name; uploadedFileMimeType = file.type || 'application/octet-stream'; fileStatus.innerHTML = `<span class="text-green-600 font-medium">File berhasil dimuat: </span><span class="text-gray-700">${uploadedFileName} (${(file.size/1024/1024).toFixed(2)} MB)</span>`; }; reader.onerror = function(){ fileStatus.innerHTML = '<span class="text-red-500">Gagal membaca file.</span>'; }; reader.readAsDataURL(file); }

function renderSickLeaveForm(){ const mainFormContainer = document.getElementById('main-form'); document.getElementById('app-intro').classList.add('hidden'); selectedSickDates.clear(); currentCalendarDate = new Date(); uploadedFileBase64 = null; uploadedFileName = null; uploadedFileMimeType = null; let formHtml = `
  <h2 class="text-2xl font-bold text-green-700 mb-6 text-center">Izin Sakit</h2>
  <div class="mb-6 p-4 border border-green-200 rounded-lg bg-green-50"><p class="text-sm font-semibold text-green-800">Karyawan: ${selectedEmployee.nama} (NRK: ${selectedEmployee.nrk})</p><p class="text-xs text-green-600">Tim: ${selectedTeam}</p></div>
  <form id="sick-leave-form" onsubmit="event.preventDefault(); submitSickLeaveForm();">
    <div class="mb-8 p-4 border rounded-lg bg-white">
      <label class="block text-gray-700 font-bold mb-3">Pilih Tanggal Sakit (H-1 dan seterusnya):</label>
      <div class="flex justify-between items-center mb-4 p-2 bg-gray-50 rounded-lg">
        <button type="button" onclick="changeMonth(-1)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full">&larr;</button>
        <span id="month-display" class="text-lg font-semibold text-gray-800"></span>
        <button type="button" onclick="changeMonth(1)" class="p-2 text-indigo-600 hover:bg-indigo-100 rounded-full">&rarr;</button>
      </div>
      <div id="calendar-grid" class="w-full"></div>
    </div>
    <div class="mb-8 p-4 border border-gray-200 rounded-lg bg-gray-50"><h4 class="text-lg font-semibold text-gray-700 mb-3 border-b pb-2">Tanggal Terpilih:</h4><div id="selected-dates-list"><p class="text-sm text-gray-500 italic">Belum ada tanggal sakit yang dipilih.</p></div></div>
    <div class="mb-8 p-4 border rounded-lg bg-white"><label for="sick-leave-file" class="block text-gray-700 font-bold mb-2">Unggah Surat Sakit (Maks. 10MB, Gambar/PDF):</label><input type="file" id="sick-leave-file" accept="image/*, .pdf" onchange="handleSickLeaveFileUpload(event)" class="block w-full text-sm text-gray-500"><p id="file-upload-status" class="mt-2 text-xs text-gray-500">Format: JPG, PNG, atau PDF.</p></div>
    <button type="submit" id="save-sick-btn" class="w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg">Simpan Data Izin Sakit</button>
    <button type="button" onclick="renderLandingPage()" class="w-full mt-3 bg-gray-500 text-white font-bold py-3 px-6 rounded-lg">&larr; Kembali ke Landing Page</button>
  </form>
`;
 mainFormContainer.innerHTML = formHtml; renderCalendar(); }

function submitSickLeaveForm(){ hideError(); if(!selectedEmployee || !selectedTeam){ showError('Sesi karyawan hilang. Harap kembali ke landing page.'); return; } const datesArray = Array.from(selectedSickDates).sort(); if(datesArray.length===0){ showError('Harap pilih minimal satu tanggal sakit.'); return; } if(!uploadedFileBase64){ showError('Harap unggah Surat Sakit terlebih dahulu.'); return; } const formData = { nama: selectedEmployee.nama, team: selectedTeam, nrk: selectedEmployee.nrk, sickDates: datesArray, formType: 'Izin Sakit' }; showLoading(); google.script.run.withSuccessHandler(onSaveSuccess).withFailureHandler(function(error){ hideLoading(); showError('Gagal menghubungi Apps Script untuk menyimpan data: ' + (error.message||error)); }).saveSickLeaveForm(formData, uploadedFileBase64, uploadedFileName, uploadedFileMimeType); }

// Navigation
function navigateToPage(pageId,pageName){ if(!selectedEmployee){ showError('Harap pilih karyawan terlebih dahulu sebelum melanjutkan.'); return; } if(pageId===1) renderFitnessForm(); else if(pageId===2) renderSickLeaveForm(); }

// Global failure handler for google.script.run (optional safety)
google.script.run.withFailureHandler(function(error){ hideLoading(); showError('Kesalahan Apps Script: ' + (error.message||error)); });

// On load
window.onload = function(){ renderLandingPage(); };
</script>
</body>
</html>
